<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TON Gift Universe - Minimal V2</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Lottie-Web Player from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <style>
        :root {
            --bg-color-start: #121212; /* Base dark */
            --bg-color-end: #18181A;   /* Slightly lighter for subtle gradient */
            --surface-color: #1E1E1E; 
            --surface-hover-color: #282828;
            
            --primary-color: #007AFF; 
            --primary-gradient-start: #007AFF;
            --primary-gradient-end: #00C6FF;  

            --secondary-color: #FF9500; 
            
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93; 
            --text-placeholder: #5c5c5f;

            --border-color: rgba(120, 120, 128, 0.16); 
            --border-highlight: var(--primary-color);

            --danger-color: #FF3B30;  
            --success-color: #34C759; 

            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --main-border-radius: 12px; 
            --button-border-radius: 8px;
            --soft-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            /* Subtle background gradient */
            background: linear-gradient(180deg, var(--bg-color-start) 0%, var(--bg-color-end) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            font-weight: 500;
            font-size: 15px;
            line-height: 1.4;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        /* Header */
        #app-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: rgba(20, 20, 22, 0.85); /* Slightly darker than bg-color-start for depth */
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-bottom: 1px solid var(--border-color);
        }
        #app-header .app-title {
            font-size: 1.25em; 
            font-weight: 700;
            color: var(--text-primary);
        }
        #app-header .wallet-info { display: flex; align-items: center; gap: 10px; }
        #app-header .wallet-address, #app-header .balance {
            background-color: var(--surface-hover-color); 
            padding: 6px 12px;
            border-radius: var(--button-border-radius);
            font-size: 0.9em;
            font-weight: 600;
        }
        #app-header .ton-icon {
            width: 16px; height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z' fill='%23007AFF'/%3E%3Cpath d='M9.62988 7.51001L8.06988 8.66001C7.82988 8.83001 7.80988 9.17001 8.00988 9.37001L11.6399 13.11C11.8399 13.31 12.1599 13.31 12.3599 13.11L15.9899 9.37001C16.1899 9.17001 16.1699 8.83001 15.9299 8.66001L14.3699 7.51001C14.1499 7.35001 13.8199 7.42001 13.6699 7.63001L12.4299 9.40001C12.1999 9.71001 11.7999 9.71001 11.5699 9.40001L10.3299 7.63001C10.1799 7.42001 9.84988 7.35001 9.62988 7.51001Z' fill='white'/%3E%3Cpath d='M8.00989 14.63L9.75989 16.38C9.93989 16.57 10.2499 16.57 10.4299 16.38L11.5699 15.24C11.7999 15.01 12.1999 15.01 12.4299 15.24L13.5699 16.38C13.7499 16.57 14.0599 16.57 14.2399 16.38L15.9899 14.63C16.1699 14.45 16.1699 14.15 15.9899 13.96L12.4199 10.31C12.1899 10.07 11.7899 10.07 11.5599 10.31L8.00989 13.96C7.80989 14.15 7.80989 14.45 8.00989 14.63Z' fill='white'/%3E%3C/svg%3E");
            background-size: contain; margin-left: 5px; vertical-align: middle;
        }

        /* Content Area */
        #app-content { flex-grow: 1; padding: 20px 16px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: pageFadeInMinimal 0.3s ease-out; }
        @keyframes pageFadeInMinimal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Navigation Bar */
        #app-nav {
            display: flex;
            justify-content: space-around;
            background-color: rgba(20, 20, 22, 0.92); 
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-top: 1px solid var(--border-color);
            padding: 8px 0; 
            position: sticky; bottom: 0; z-index: 1000;
        }
        .nav-button {
            background: none; border: none;
            color: var(--text-secondary);
            display: flex; flex-direction: column; align-items: center;
            font-size: 10px; 
            font-weight: 500;
            cursor: pointer; padding: 4px 5px; 
            border-radius: var(--button-border-radius);
            transition: color 0.2s;
            flex: 1; text-align: center;
        }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg {
            width: 22px; height: 22px; margin-bottom: 2px; fill: currentColor;
        }
        .nav-button.active svg { fill: var(--primary-color); }


        /* General UI Elements */
        .button {
            background-color: var(--primary-color);
            color: var(--text-primary);
            border: none; padding: 12px 20px;
            border-radius: var(--button-border-radius);
            font-size: 1.05em; 
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s ease-out, transform 0.1s ease-out;
            text-align: center;
            display: block; 
            width: 100%;
        }
        .button:hover { background-color: color-mix(in srgb, var(--primary-color) 85%, black); }
        .button:active { transform: scale(0.98); }
        .button-secondary {
            background-color: var(--surface-hover-color);
            color: var(--primary-color); 
        }
        .button-secondary:hover { background-color: var(--surface-color); }

        h2 {
            margin-top: 0; font-size: 1.75em; 
            font-weight: 700;
            color: var(--text-primary);
            padding-bottom: 8px; margin-bottom: 24px;
        }
        h3 { 
            font-size: 1.1em; 
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 20px;
            margin-bottom: 12px;
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        .content-card { 
            background-color: var(--surface-color);
            padding: 16px;
            border-radius: var(--main-border-radius);
            margin-bottom: 16px;
        }


        /* Main Page - Cases */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }
        .case-card {
            background-color: var(--surface-color);
            border-radius: var(--main-border-radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .case-card:hover {
            background-color: var(--surface-hover-color);
            transform: translateY(-4px);
        }
        .case-card .case-image-placeholder { 
            font-size: 2.5em;
            margin-bottom: 12px;
            line-height: 1;
        }
        .case-card .case-name {
            font-weight: 600; font-size: 1em; margin-bottom: 6px;
            color: var(--text-primary);
        }
        .case-card .case-price {
            font-size: 0.9em; font-weight: 500;
            color: var(--text-secondary);
        }

        /* Roulette Modal */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
            padding: 16px;
        }
        .modal.active { display: flex; animation: modalFadeInMinimal 0.2s ease-out; }
        @keyframes modalFadeInMinimal {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: var(--main-border-radius);
            width: 100%; max-width: 380px; 
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-content h3 { /* Modal title */
            margin-top: 0; margin-bottom: 16px;
            font-size: 1.25em; font-weight: 600;
            color: var(--text-primary);
        }
        /* REMOVED: #roulette-wheel-container p (Possible Items text) */
        #roulette-wheel {
            height: 180px; 
            border: 1px solid var(--border-color);
            border-radius: var(--button-border-radius);
            overflow: hidden; position: relative;
            background-color: var(--bg-color); 
            margin: 16px 0;
        }
        #roulette-wheel::before { 
            content: '';
            position: absolute;
            left: 0px; 
            right: 0px;
            top: 50%;
            transform: translateY(-50%);
            height: 60px; 
            border-top: 2px solid var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            opacity: 0.5;
            z-index: 2;
            pointer-events: none; 
        }
        #roulette-spinner {
            display: flex; flex-direction: column;
            position: absolute; left: 0; width: 100%;
        }
        .roulette-item {
            height: 60px; 
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 0 16px;
            box-sizing: border-box;
            border-bottom: 1px solid var(--border-color);
            background-color: transparent; 
        }
        .roulette-item:last-child { border-bottom: none; }
        .roulette-item-name {
            font-size: 1em; font-weight: 500; color: var(--text-secondary);
        }
        .roulette-item-value { 
            font-size: 0.85em; font-weight: 500; color: var(--secondary-color);
        }
        .roulette-item.is-winning .roulette-item-name { 
            color: var(--text-primary) !important;
            font-weight: 700;
        }
        #prize-display {
            margin-top: 20px; font-size: 1.2em; font-weight: 600;
            color: var(--success-color);
        }
        #prize-display.hidden { display: none; }
        .modal-actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Input fields minimal style */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 12px;
            border-radius: var(--button-border-radius);
            background-color: var(--surface-hover-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            font-size: 1em; font-weight: 500;
            box-sizing: border-box;
        }
        input[type="text"]::placeholder, input[type="number"]::placeholder { color: var(--text-placeholder); }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--border-highlight);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); 
        }

        /* Profile Page Specifics */
        .profile-header { text-align: center; margin-bottom: 24px; padding-top: 10px;}
        .profile-avatar-placeholder {
            width: 80px; height: 80px; border-radius: 50%;
            background-color: var(--surface-hover-color);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5em; font-weight: 600; color: var(--text-secondary);
            margin: 0 auto 12px auto;
            border: 2px solid var(--border-color);
        }
        .profile-info .username { font-size: 1.4em; font-weight: 600; margin-bottom: 4px;}
        .profile-info .userid { font-size: 0.9em; color: var(--text-secondary); }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        .inventory-item {
            background-color: var(--surface-hover-color);
            border-radius: var(--button-border-radius);
            padding: 12px; text-align: center;
        }
        .inventory-item-name { font-size: 0.9em; font-weight: 500; margin-bottom: 6px; }
        .inventory-item-value { font-size: 0.8em; color: var(--secondary-color); font-weight: 500; margin-bottom: 8px;}
        .inventory-item-actions .button { font-size: 0.8em; padding: 6px 10px; }
        
        /* Upgrade Page */
        #upgrade-chance-display {
            font-size: 2.5em; font-weight: 700; color: var(--text-primary);
            text-align:center; margin: 20px 0; padding: 15px;
            background-color: var(--surface-hover-color);
            border-radius: 50%; width:100px; height:100px; line-height: 70px; margin-left:auto; margin-right:auto;
            border: 3px solid var(--primary-color);
        }
        .multiplier-buttons { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
        .multiplier-buttons button { width: auto; flex-grow: 1; padding: 10px; font-size: 0.9em;}
        .multiplier-buttons button.active-multiplier {
            background-color: var(--primary-color);
            color: var(--text-primary);
        }
        
        /* Invite Page */
        .stats-box { display: flex; justify-content: space-around; margin: 20px 0; gap: 12px; }
        .stat-item {
            background-color: var(--surface-hover-color);
            padding: 12px; border-radius: var(--button-border-radius);
            flex: 1; text-align: center;
        }
        .stat-item .value { font-size: 1.5em; font-weight: 600; color: var(--primary-color); }
        .stat-item .label { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; }
        .invited-users-list div { padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em;}
        .invited-users-list div:last-child { border-bottom: none; }

        /* Leaderboard Page */
        .leaderboard-list .leader-entry {
            display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .leaderboard-list .leader-entry:last-child { border-bottom: none; }
        .leader-entry .rank {
            font-weight: 600; font-size: 1em;
            min-width: 30px; text-align: left; color: var(--text-secondary);
        }
        .leader-entry .avatar-placeholder { 
            width: 36px; height: 36px; border-radius: 50%;
            background-color: var(--surface-hover-color); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1em; font-weight: 600; margin: 0 12px;
        }
        .leader-entry .info .name { font-weight: 500; font-size: 1em; }
        .leader-entry .info .details { font-size: 0.8em; color: var(--text-secondary); }
        .leader-entry .score {
            margin-left: auto; font-weight: 600; font-size: 1em;
            color: var(--text-primary);
        }
         .leader-entry.current-user-entry .info .name {
             color: var(--primary-color);
        }

    </style>
</head>
<body>
    <div id="app-container">
        <header id="app-header">
            <div class="app-title">Gift Universe</div>
            <div class="wallet-info">
                <div id="wallet-address" class="wallet-address">Connect Wallet</div>
                <div id="balance" class="balance">
                    <span id="ton-balance">0.00</span> <span class="ton-icon"></span>
                </div>
            </div>
        </header>

        <main id="app-content">
            <div id="main-page" class="page active">
                <h2>Cases</h2>
                <div id="cases-grid" class="cases-grid">
                    <!-- Cases will be dynamically inserted here -->
                </div>
            </div>

             <div id="upgrade-page" class="page">
                <h2>Enhance Item</h2>
                <div class="content-card">
                    <p style="text-align:center; margin-bottom:15px; color: var(--text-secondary);">Select an item from your collection:</p>
                    <select id="upgrade-inventory-select">
                        <option value="">-- Choose Item --</option>
                    </select>
                    <div id="upgrade-chance-display">50%</div>
                     <p style="text-align:center; margin-bottom:10px; color: var(--text-secondary);">Multiplier:</p>
                    <div id="multiplier-buttons" class="multiplier-buttons">
                        <button class="button button-secondary" data-multiplier="1.5">x1.5</button>
                        <button class="button button-secondary" data-multiplier="2">x2</button>
                        <button class="button button-secondary" data-multiplier="3">x3</button>
                        <button class="button button-secondary" data-multiplier="5">x5</button>
                        <button class="button button-secondary" data-multiplier="10">x10</button>
                        <button class="button button-secondary" data-multiplier="20">x20</button>
                    </div>
                    <button id="do-upgrade-button" class="button">Attempt Enhancement</button>
                    <p id="upgrade-result" style="margin-top: 15px; font-weight: 500; text-align:center;"></p>
                </div>
            </div>

            <div id="invite-page" class="page">
                <h2>Referrals</h2>
                 <div class="content-card">
                    <p style="font-size: 1em; margin-bottom: 15px; text-align:center; color:var(--text-secondary);">Invite friends and earn <strong>10%</strong> of their deposits!</p>
                    <input type="text" id="referral-link" value="https://t.me/YourAppBot?start=ref_USER123" readonly>
                    <button id="copy-ref-link-button" class="button" style="margin-bottom: 20px;">Copy Referral Code</button>
                    
                    <div class="stats-box" style="margin-bottom: 20px;">
                        <div class="stat-item">
                            <div id="referral-balance" class="value">0.00 <span class="ton-icon" style="width:16px; height:16px;"></span></div>
                            <div class="label">Referral Earnings</div>
                        </div>
                        <div class="stat-item">
                            <div id="invited-count" class="value">0</div>
                            <div class="label">Friends Invited</div>
                        </div>
                    </div>
                    <button id="withdraw-referral-button" class="button button-secondary">Withdraw Earnings</button>
                </div>
                <div class="content-card">
                    <h3>Invited Friends (Demo)</h3>
                    <div class="invited-users-list">
                        <div>User_Alpha7 - Profit: 1.5 TON</div>
                        <div>User_BetaMax - Profit: 0.5 TON</div>
                    </div>
                </div>
            </div>


            <div id="leaderboard-page" class="page">
                <h2>Leaderboard</h2>
                <div id="leaderboard-list" class="leaderboard-list content-card" style="padding-top:0; padding-bottom:0;">
                    <!-- Leaderboard entries -->
                </div>
            </div>

            <div id="profile-page" class="page">
                <div class="profile-header">
                    <div id="profile-avatar" class="profile-avatar-placeholder">V</div>
                    <div class="profile-info">
                        <div id="profile-username" class="username">Vasiliy</div>
                        <div id="profile-userid" class="userid">#5146625949</div>
                    </div>
                </div>

                <div class="content-card">
                    <h3>Balance</h3>
                    <div id="profile-balance-display" style="font-size:1.6em; font-weight:600; margin-bottom:10px;">100.00 <span class="ton-icon" style="width:20px; height:20px;"></span></div>
                    <input type="number" id="deposit-amount-input" placeholder="Amount in TON" style="margin-bottom: 10px;">
                    <button id="confirm-deposit-button" class="button">Deposit TON (Test)</button>
                </div>

                <div class="content-card">
                     <h3>Wallet</h3>
                    <div id="profile-wallet-address" style="color:var(--text-secondary); margin-bottom:10px; word-break:break-all;">UQBoR...3064 (Demo)</div>
                    <button id="disconnect-wallet-button" class="button button-secondary">Disconnect Wallet</button>
                </div>

                <div class="content-card">
                    <h3>My Collection (<span id="inventory-count">0</span>)</h3>
                    <div id="inventory-grid" class="inventory-grid">
                        <p id="empty-inventory-message" style="grid-column: 1 / -1; text-align: center; color: var(--text-placeholder); padding:15px 0;">Your collection is empty.</p>
                        <!-- Inventory items will be here -->
                    </div>
                </div>
            </div>
        </main>

        <nav id="app-nav">
            <button class="nav-button active" data-page="main-page">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                Cases
            </button>
            <button class="nav-button" data-page="upgrade-page">
                 <svg viewBox="0 0 24 24"><path d="M9.48 5.55L6.91 8.12L5.5 6.71L9.48 2.73L13.47 6.71L12.06 8.12L9.48 5.55M9.48 5.55V13.75C9.48 14.15 9.15 14.48 8.75 14.48C8.35 14.48 8.02 14.15 8.02 13.75V5.55L5.45 8.12L4.04 6.71L8.02 2.73L12.01 6.71L10.6 8.12L8.02 5.55M15.25 10.25C14.85 10.25 14.52 10.58 14.52 10.98V19.18L11.95 16.61L10.54 18L14.52 21.99L18.5 18L17.09 16.61L14.52 19.18V10.98C14.52 10.58 14.19 10.25 13.79 10.25H15.25Z"/></svg>
                Enhance
            </button>
            <button class="nav-button" data-page="invite-page">
                 <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                Referrals
            </button>
            <button class="nav-button" data-page="leaderboard-page">
                <svg viewBox="0 0 24 24"><path d="M16,1H4C2.89,1 2,1.89 2,3V17H4V3H16V1M16.5,5H7.5C6.67,5 6,5.67 6,6.5V22.5L12,19.5L18,22.5V6.5C18,5.67 17.33,5 16.5,5M14,11H10V9H14V11M14,15H10V13H14V15Z" /></svg>
                Leaders
            </button>
            <button class="nav-button" data-page="profile-page">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                Profile
            </button>
        </nav>
    </div>

    <!-- Roulette Modal -->
    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <h3 id="roulette-case-name">Opening Case...</h3>
            <div id="roulette-wheel-container">
                <!-- REMOVED "Possible Items" text from here -->
                <div id="roulette-wheel">
                    <div id="roulette-spinner">
                        <!-- Prize items will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div id="prize-display" class="hidden">
                You got: <span id="won-prize-name"></span>!
            </div>
            <div class="modal-actions">
                <button id="spin-button" class="button">Spin</button>
                <button id="close-roulette-button" class="button button-secondary">Close</button>
            </div>
        </div>
    </div>

<script>
// --- Constants and Global State ---
const GIFT_IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/GiftGifs/';

const currentUser = {
    id: '5146625949',
    username: 'Vasiliy',
    walletAddress: 'UQBoR...3064', 
    tonBalance: 100.00,
    starBalance: 2000,
    inventory: [],
    referralCode: 'ref_VASILIY123',
    referralEarnings: 0,
    invitedUsersCount: 2
};

let currentOpenCase = null;
let selectedMultiplier = 1.5;

// REGULAR CASE REMOVED
const casesData = [
    {
        id: 'lolpop', name: '🍭 Lol Pop Stash', priceTON: 0.5,
        prizes: [
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.01 },
            { name: 'Party Sparkler', tgsFile: 'Party-Sparkler.tgs', floorPrice: 1, probability: 0.10 },
            { name: 'B-Day Candle', tgsFile: 'B-Day-Candle.tgs', floorPrice: 0.7, probability: 0.10 },
            { name: 'Homemade Cake', tgsFile: 'Homemade-Cake.tgs', floorPrice: 1, probability: 0.09 },
            { name: 'Lol Pop', tgsFile: 'Lol-Pop.tgs', floorPrice: 0.7, probability: 0.20 },
            { name: 'Hynpo Lollipop', tgsFile: 'Hynpo-Lollipop.tgs', floorPrice: 0.7, probability: 0.20 },
            { name: 'Desk Calendar', tgsFile: 'Desk-Calendar.tgs', floorPrice: 0.7, probability: 0.10 },
            { name: 'Cookie Heart', tgsFile: 'Cookie-Heart.tgs', floorPrice: 0.9, probability: 0.10 },
            { name: 'Jack-in-the-box', tgsFile: 'Jack-in-the-box.tgs', floorPrice: 1, probability: 0.08 },
            { name: 'Skull Flower', tgsFile: 'Skull-Flower.tgs', floorPrice: 1.7, probability: 0.02 },
        ]
    },
    {
        id: 'recordplayer', name: '🎶 Record Player Vault', priceTON: 3,
        prizes: [
            { name: 'Record Player', tgsFile: 'Record-Player.tgs', floorPrice: 2, probability: 0.50 },
            { name: 'Lol Pop', tgsFile: 'Lol-Pop.tgs', floorPrice: 0.7, probability: 0.08 },
            { name: 'Hynpo Lollipop', tgsFile: 'Hynpo-Lollipop.tgs', floorPrice: 0.7, probability: 0.08 },
            { name: 'Party Sparkler', tgsFile: 'Party-Sparkler.tgs', floorPrice: 1, probability: 0.08 },
            { name: 'Skull Flower', tgsFile: 'Skull-Flower.tgs', floorPrice: 1.7, probability: 0.08 },
            { name: 'Jelly Bunny', tgsFile: 'Jelly-Bunny.tgs', floorPrice: 1.8, probability: 0.08 },
            { name: 'Tama Gadget', tgsFile: 'Tama-Gadget.tgs', floorPrice: 2, probability: 0.05 },
            { name: 'Snow Globe', tgsFile: 'Snow-Globe.tgs', floorPrice: 2, probability: 0.05 },
        ]
    },
    {
        id: 'swisswatch', name: '⌚ Swiss Watch Box', priceTON: 5,
        prizes: [
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.20 },
            { name: 'Record Player', tgsFile: 'Record-Player.tgs', floorPrice: 2, probability: 0.10 },
            { name: 'Love Potion', tgsFile: 'Love-Potion.tgs', floorPrice: 2.7, probability: 0.15 },
            { name: 'Top Hat', tgsFile: 'Top-Hat.tgs', floorPrice: 3, probability: 0.15 },
            { name: 'Voodoo Doll', tgsFile: 'Voodoo-Doll.tgs', floorPrice: 4.2, probability: 0.10 },
            { name: 'Eternal Rose', tgsFile: 'Eternal-Rose.tgs', floorPrice: 5.5, probability: 0.10 },
            { name: 'Electric Skull', tgsFile: 'Electric-Skull.tgs', floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', tgsFile: 'Diamond-Ring.tgs', floorPrice: 5.7, probability: 0.05 },
        ]
    },
    {
        id: 'perfumebottle', name: '💧 Perfume Chest', priceTON: 10,
        prizes: [
            { name: 'Perfume Bottle', tgsFile: 'Perfume-Bottle.tgs', floorPrice: 21, probability: 0.10 },
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.15 },
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.20 },
            { name: 'Genie Lamp', tgsFile: 'Genie-Lamp.tgs', floorPrice: 9.6, probability: 0.15 },
            { name: 'Sharp Tongue', tgsFile: 'Sharp-Tongue.tgs', floorPrice: 10, probability: 0.10 },
            { name: 'Kissed Frog', tgsFile: 'Kissed-Frog.tgs', floorPrice: 9, probability: 0.10 },
            { name: 'Loot Bag', tgsFile: 'Loot-Bag.tgs', floorPrice: 12, probability: 0.05 },
            { name: 'Electric Skull', tgsFile: 'Electric-Skull.tgs', floorPrice: 6.3, probability: 0.10 },
            { name: 'Diamond Ring', tgsFile: 'Diamond-Ring.tgs', floorPrice: 5.7, probability: 0.05 },
        ]
    },
    {
        id: 'vintagecigar', name: '🚬 Vintage Cigar Safe', priceTON: 20,
        prizes: [
            { name: 'Vintage Cigar', tgsFile: 'Vintage-CIgar.tgs', floorPrice: 13, probability: 0.10 },
            { name: 'Perfume Bottle', tgsFile: 'Perfume-Bottle.tgs', floorPrice: 21, probability: 0.15 },
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.20 },
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.15 },
            { name: 'Sharp Tongue', tgsFile: 'Sharp-Tongue.tgs', floorPrice: 10, probability: 0.15 },
            { name: 'Genie Lamp', tgsFile: 'Genie-Lamp.tgs', floorPrice: 9.6, probability: 0.10 },
            { name: 'Mini Oscar', tgsFile: 'Mini-Oscar.tgs', floorPrice: 18, probability: 0.08 },
            { name: 'Scared Cat', tgsFile: 'Scared-Cat.tgs', floorPrice: 17, probability: 0.07 },
        ]
    },
    {
        id: 'astralshard', name: '✨ Astral Shard Relic', priceTON: 50,
        prizes: [
            { name: 'Astral Shard', tgsFile: 'Astral-Shard.tgs', floorPrice: 60, probability: 0.10 },
            { name: 'Vintage Cigar', tgsFile: 'Vintage-CIgar.tgs', floorPrice: 13, probability: 0.15 },
            { name: 'Perfume Bottle', tgsFile: 'Perfume-Bottle.tgs', floorPrice: 21, probability: 0.15 },
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.10 },
            { name: 'Precious Peach', tgsFile: 'Precious-Peach.tgs', floorPrice: 60, probability: 0.10 },
            { name: 'Mini Oscar', tgsFile: 'Mini-Oscar.tgs', floorPrice: 18, probability: 0.15 },
            { name: 'Scared Cat', tgsFile: 'Scared-Cat.tgs', floorPrice: 17, probability: 0.10 },
            { name: 'Loot Bag', tgsFile: 'Loot-Bag.tgs', floorPrice: 12, probability: 0.05 },
        ]
    },
    {
        id: 'plushpepe', name: '🐸 Plush Pepe Hoard', priceTON: 100,
        prizes: [
            { name: 'Plush Pepe', tgsFile: 'Plush-Pepe.tgs', floorPrice: 560, probability: 0.10 },
            { name: 'Durov\'s Cap', tgsFile: 'Durovs-Cap.tgs', floorPrice: 150, probability: 0.50 },
            { name: 'Astral Shard', tgsFile: 'Astral-Shard.tgs', floorPrice: 60, probability: 0.40 },
        ]
    },
    {
        id: 'happypepe', name: '🥳 Happy Pepe Treasure', priceTON: 600,
        prizes: [
            { name: 'Kissed Frog Happy Pepe', tgsFile: 'Happy Pepe Kissed Frog.tgs', floorPrice: 660, probability: 0.3636 },
            { name: 'Plush Pepe', tgsFile: 'Plush-Pepe.tgs', floorPrice: 560, probability: 0.6364 },
        ]
    },
    {
        id: 'amber', name: '🔶 Amber Nebula Case', priceTON: 3,
        prizes: [
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.01 },
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.03 },
            { name: 'Electric Skull', tgsFile: 'Electric-Skull.tgs', floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', tgsFile: 'Diamond-Ring.tgs', floorPrice: 5.7, probability: 0.10 },
            { name: 'Eternal Rose', tgsFile: 'Eternal-Rose.tgs', floorPrice: 5.5, probability: 0.15 },
            { name: 'Voodoo Doll', tgsFile: 'Voodoo-Doll.tgs', floorPrice: 4.2, probability: 0.15 },
            { name: 'Top Hat', tgsFile: 'Top-Hat.tgs', floorPrice: 3, probability: 0.15 },
            { name: 'Record Player', tgsFile: 'Record-Player.tgs', floorPrice: 2, probability: 0.08 },
            { name: 'Love Potion', tgsFile: 'Love-Potion.tgs', floorPrice: 2.7, probability: 0.08 },
            { name: 'Sakura Flower', tgsFile: 'Sakura-Flower.tgs', floorPrice: 2, probability: 0.08 },
            { name: 'Jelly Bunny', tgsFile: 'Jelly-Bunny.tgs', floorPrice: 1.8, probability: 0.06 },
            { name: 'Skull Flower', tgsFile: 'Skull-Flower.tgs', floorPrice: 1.7, probability: 0.06 },
        ]
    },
    {
        id: 'midnightblue', name: '🔷 Midnight Blue Comet', priceTON: 3,
        prizes: [
            { name: 'Genie Lamp', tgsFile: 'Genie-Lamp.tgs', floorPrice: 9.6, probability: 0.01 },
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.03 },
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.06 },
            { name: 'Electric Skull', tgsFile: 'Electric-Skull.tgs', floorPrice: 6.3, probability: 0.10 },
            { name: 'Diamond Ring', tgsFile: 'Diamond-Ring.tgs', floorPrice: 5.7, probability: 0.15 },
            { name: 'Eternal Rose', tgsFile: 'Eternal-Rose.tgs', floorPrice: 5.5, probability: 0.15 },
            { name: 'Top Hat', tgsFile: 'Top-Hat.tgs', floorPrice: 3, probability: 0.15 },
            { name: 'Love Potion', tgsFile: 'Love-Potion.tgs', floorPrice: 2.7, probability: 0.08 },
            { name: 'Tama Gadget', tgsFile: 'Tama-Gadget.tgs', floorPrice: 2, probability: 0.08 },
            { name: 'Snow Globe', tgsFile: 'Snow-Globe.tgs', floorPrice: 2, probability: 0.08 },
            { name: 'Sleigh Bell', tgsFile: 'Sleigh-Bell.tgs', floorPrice: 2, probability: 0.06 },
            { name: 'Candy Cane', tgsFile: 'Candy-Cane.tgs', floorPrice: 0.9, probability: 0.05 },
        ]
    },
    {
        id: 'onyxblack', name: '⚫ Onyx Black Hole', priceTON: 5,
        prizes: [
            { name: 'Sharp Tongue', tgsFile: 'Sharp-Tongue.tgs', floorPrice: 10, probability: 0.01 },
            { name: 'Genie Lamp', tgsFile: 'Genie-Lamp.tgs', floorPrice: 9.6, probability: 0.03 },
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.05 },
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.10 },
            { name: 'Electric Skull', tgsFile: 'Electric-Skull.tgs', floorPrice: 6.3, probability: 0.15 },
            { name: 'Diamond Ring', tgsFile: 'Diamond-Ring.tgs', floorPrice: 5.7, probability: 0.15 },
            { name: 'Eternal Rose', tgsFile: 'Eternal-Rose.tgs', floorPrice: 5.5, probability: 0.15 },
            { name: 'Voodoo Doll', tgsFile: 'Voodoo-Doll.tgs', floorPrice: 4.2, probability: 0.10 },
            { name: 'Top Hat', tgsFile: 'Top-Hat.tgs', floorPrice: 3, probability: 0.08 },
            { name: 'Toy Bear', tgsFile: 'Toy-Bear.tgs', floorPrice: 5.2, probability: 0.08 },
            { name: 'Love Potion', tgsFile: 'Love-Potion.tgs', floorPrice: 2.7, probability: 0.05 },
            { name: 'Record Player', tgsFile: 'Record-Player.tgs', floorPrice: 2, probability: 0.05 },
        ]
    },
    {
        id: 'black', name: '🖤 BLACK Singularity', priceTON: 15,
        prizes: [
            { name: 'Perfume Bottle', tgsFile: 'Perfume-Bottle.tgs', floorPrice: 21, probability: 0.01 },
            { name: 'Mini Oscar', tgsFile: 'Mini-Oscar.tgs', floorPrice: 18, probability: 0.03 },
            { name: 'Scared Cat', tgsFile: 'Scared-Cat.tgs', floorPrice: 17, probability: 0.05 },
            { name: 'Vintage Cigar', tgsFile: 'Vintage-CIgar.tgs', floorPrice: 13, probability: 0.10 },
            { name: 'Loot Bag', tgsFile: 'Loot-Bag.tgs', floorPrice: 12, probability: 0.15 },
            { name: 'Sharp Tongue', tgsFile: 'Sharp-Tongue.tgs', floorPrice: 10, probability: 0.15 },
            { name: 'Genie Lamp', tgsFile: 'Genie-Lamp.tgs', floorPrice: 9.6, probability: 0.15 },
            { name: 'Swiss Watch', tgsFile: 'Swiss-Watch.tgs', floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', tgsFile: 'Neko-Helmet.tgs', floorPrice: 7.5, probability: 0.10 },
            { name: 'Kissed Frog', tgsFile: 'Kissed-Frog.tgs', floorPrice: 9, probability: 0.08 },
            { name: 'Electric Skull', tgsFile: 'Electric-Skull.tgs', floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', tgsFile: 'Diamond-Ring.tgs', floorPrice: 5.7, probability: 0.03 },
        ]
    },
];


// --- DOM Elements --- (Same as previous JS)
// ...
// --- Utility Functions --- (Same as previous JS)
// ...
// --- Rendering Functions --- (Same as previous JS, ensure showTGNotification is used)
// ...
// --- Roulette Logic --- (Same as previous JS)
// ...
// --- Other Page Logic --- (Same as previous JS, ensure handleDeposit is included)
// ...
// --- Event Listeners --- (Same as previous JS)
// ...
// --- Initialization --- (Same as previous JS)

// For brevity, I'm pasting the full JS again below. Make sure only one <script> block with this content exists.
// (The JS from the previous "HTML JS without CSS" answer is what should be here)
const appHeader = {
    walletAddress: document.getElementById('wallet-address'),
    tonBalance: document.getElementById('ton-balance'),
};
const appNavButtons = document.querySelectorAll('.nav-button');
const pages = document.querySelectorAll('.page');
const casesGrid = document.getElementById('cases-grid');

const rouletteModal = document.getElementById('roulette-modal');
const rouletteCaseName = document.getElementById('roulette-case-name');
const rouletteWheel = document.getElementById('roulette-wheel');
const rouletteSpinner = document.getElementById('roulette-spinner');
const prizeDisplay = document.getElementById('prize-display');
const wonPrizeName = document.getElementById('won-prize-name');
const spinButton = document.getElementById('spin-button');
const closeRouletteButton = document.getElementById('close-roulette-button');

const profileElements = {
    avatar: document.getElementById('profile-avatar'),
    username: document.getElementById('profile-username'),
    userid: document.getElementById('profile-userid'),
    balanceDisplay: document.getElementById('profile-balance-display'),
    walletAddress: document.getElementById('profile-wallet-address'),
    inventoryGrid: document.getElementById('inventory-grid'),
    inventoryCount: document.getElementById('inventory-count'),
    emptyInventoryMessage: document.getElementById('empty-inventory-message'),
    disconnectWalletButton: document.getElementById('disconnect-wallet-button'),
    depositAmountInput: document.getElementById('deposit-amount-input'),
    confirmDepositButton: document.getElementById('confirm-deposit-button')
};

const upgradeElements = {
    inventorySelect: document.getElementById('upgrade-inventory-select'),
    multiplierButtons: document.getElementById('multiplier-buttons'),
    doUpgradeButton: document.getElementById('do-upgrade-button'),
    upgradeResult: document.getElementById('upgrade-result'),
    chanceDisplay: document.getElementById('upgrade-chance-display') 
};

const inviteElements = {
    referralLink: document.getElementById('referral-link'),
    copyRefLinkButton: document.getElementById('copy-ref-link-button'),
    referralBalance: document.getElementById('referral-balance'),
    invitedCount: document.getElementById('invited-count'),
    withdrawReferralButton: document.getElementById('withdraw-referral-button')
};

const leaderboardList = document.getElementById('leaderboard-list');

// --- Utility Functions ---
function updateBalances() {
    appHeader.tonBalance.textContent = currentUser.tonBalance.toFixed(2);
    profileElements.balanceDisplay.innerHTML = `${currentUser.tonBalance.toFixed(2)} <span class="ton-icon"></span>`;
}

function navigateToPage(pageId) {
    pages.forEach(page => page.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    appNavButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === pageId);
    });
    window.scrollTo(0, 0); 
}

function showTGNotification(message, type = 'info') { 
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.showAlert) {
        Telegram.WebApp.showAlert(message);
    } else {
        alert(message); 
    }
    if (window.Telegram && Telegram.WebApp.HapticFeedback) {
        if (type === 'success') Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        else if (type === 'error') Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        else if (type === 'warning') Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
    }
}

// --- Rendering Functions ---
function renderHeader() {
    if (currentUser.walletAddress && currentUser.walletAddress !== "Connect Wallet") {
        appHeader.walletAddress.textContent = currentUser.walletAddress.substring(0, 5) + '...' + currentUser.walletAddress.substring(currentUser.walletAddress.length - 4);
        appHeader.walletAddress.onclick = null; 
    } else {
        appHeader.walletAddress.textContent = "Connect Wallet";
        appHeader.walletAddress.onclick = () => {
            currentUser.walletAddress = "UQDemoWalletAddrLongSampleText12345"; 
            renderHeader();
            showTGNotification("Wallet Connected (Demo)!", 'success');
        };
    }
    updateBalances();
}

function renderCases() {
    casesGrid.innerHTML = '';
    casesData.forEach(caseItem => {
        const card = document.createElement('div');
        card.className = 'case-card';
        card.onclick = () => openRouletteModal(caseItem);

        const imagePlaceholder = document.createElement('div');
        imagePlaceholder.className = 'case-image-placeholder';
        imagePlaceholder.textContent = caseItem.name.substring(0, caseItem.name.indexOf(' ') +1).trim() || '🎁';

        const name = document.createElement('div');
        name.className = 'case-name';
        name.textContent = caseItem.name;

        const price = document.createElement('div');
        price.className = 'case-price';
        let priceText = '';
        if (caseItem.priceTON) priceText += `${caseItem.priceTON.toFixed(1)} TON `;
        if (caseItem.priceStars) priceText += (priceText ? '/ ' : '') + `${caseItem.priceStars} ✨`;
        price.textContent = priceText || 'Free';

        card.appendChild(imagePlaceholder);
        card.appendChild(name);
        card.appendChild(price);
        casesGrid.appendChild(card);
    });
}

function renderProfile() {
    profileElements.avatar.textContent = currentUser.username ? currentUser.username.charAt(0).toUpperCase() : 'U';
    profileElements.username.textContent = currentUser.username || 'User';
    profileElements.userid.textContent = currentUser.id ? `#${currentUser.id}` : '';
    profileElements.walletAddress.textContent = (currentUser.walletAddress && currentUser.walletAddress !== "Connect Wallet") ? currentUser.walletAddress : 'Not Connected';
    renderInventory();
}

function renderInventory() {
    profileElements.inventoryGrid.innerHTML = '';
    if (currentUser.inventory.length === 0) {
        profileElements.emptyInventoryMessage.style.display = 'block';
    } else {
        profileElements.emptyInventoryMessage.style.display = 'none';
        currentUser.inventory.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item';
            itemDiv.innerHTML = `
                <div class="inventory-item-name" title="${item.name}">${item.name}</div>
                <div class="inventory-item-value">${item.floorPrice.toFixed(2)} TON</div>
                <div class="inventory-item-actions">
                    <button class="button button-secondary" onclick="convertToTon('${item.id}')">Convert</button>
                </div>
            `;
            profileElements.inventoryGrid.appendChild(itemDiv);
        });
    }
    profileElements.inventoryCount.textContent = currentUser.inventory.length;
    populateUpgradeInventorySelect();
}

function populateUpgradeInventorySelect() {
    upgradeElements.inventorySelect.innerHTML = '<option value="">-- Choose Item --</option>';
    currentUser.inventory.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = `${item.name} (${item.floorPrice.toFixed(2)} TON)`;
        upgradeElements.inventorySelect.appendChild(option);
    });
}

function renderLeaderboard() {
    leaderboardList.innerHTML = ''; 
    const leaders = [ 
        { rank: 1, name: 'NovaPrime', avatarChar: 'N', opened: 250, income: 1850.5 },
        { rank: 2, name: 'Starlord77', avatarChar: 'S', opened: 220, income: 1580.2 },
        { rank: 3, name: 'GalaxyGlider', avatarChar: 'G', opened: 300, income: 1250.0 },
        { rank: 4, name: 'CometChaser', avatarChar: 'C', opened: 190, income: 900.7 },
        { rank: 5, name: currentUser.username, avatarChar: currentUser.username.charAt(0), opened: 10, income: Math.max(0, currentUser.tonBalance - 100 + currentUser.inventory.reduce((sum, item) => sum + item.floorPrice, 0)), isCurrentUser: true },
    ].sort((a, b) => b.income - a.income).map((leader, index) => ({...leader, rank: index + 1})); 

    leaders.forEach(leader => {
        const entry = document.createElement('div');
        entry.className = 'leader-entry';
        if (leader.isCurrentUser) entry.classList.add('current-user-entry');
        entry.innerHTML = `
            <div class="rank">#${leader.rank}</div>
            <div class="avatar-placeholder">${leader.avatarChar}</div>
            <div class="info">
                <div class="name">${leader.name}</div>
                <div class="details">Opened ${leader.opened} cases</div>
            </div>
            <div class="score">${leader.income.toFixed(1)} <span class="ton-icon"></span></div>
        `;
        leaderboardList.appendChild(entry);
    });
}

function renderInvitePage() {
    inviteElements.referralLink.value = `https://t.me/YourAppBot?start=${currentUser.referralCode}`;
    inviteElements.referralBalance.innerHTML = `${currentUser.referralEarnings.toFixed(2)} <span class="ton-icon"></span>`;
    inviteElements.invitedCount.textContent = currentUser.invitedUsersCount;
}


// --- Roulette Logic ---
function openRouletteModal(caseItem) {
    currentOpenCase = caseItem;
    rouletteCaseName.textContent = caseItem.name; 
    spinButton.textContent = `Spin (${caseItem.priceTON ? caseItem.priceTON.toFixed(1) + ' TON' : ''} ${caseItem.priceStars && caseItem.priceTON ? '/' : ''} ${caseItem.priceStars ? caseItem.priceStars + ' ✨' : ''})`;
    spinButton.disabled = false;
    prizeDisplay.classList.add('hidden');
    wonPrizeName.textContent = '';
    rouletteSpinner.innerHTML = ''; 
    rouletteSpinner.style.transition = 'none'; 
    rouletteSpinner.style.top = '0px'; 

    let spinnerItemsContent = [];
    currentOpenCase.prizes.forEach(p => spinnerItemsContent.push(p));
    for (let i = spinnerItemsContent.length; i < 80; i++) { 
        spinnerItemsContent.push(currentOpenCase.prizes[Math.floor(Math.random() * currentOpenCase.prizes.length)]);
    }
    
    spinnerItemsContent.forEach(prize => {
        const itemEl = document.createElement('div');
        itemEl.className = 'roulette-item';
        itemEl.innerHTML = `
            <span class="roulette-item-name">${prize.name}</span>
            <span class="roulette-item-value">${prize.floorPrice.toFixed(2)} TON</span>
        `;
        rouletteSpinner.appendChild(itemEl);
    });

    rouletteModal.classList.add('active');
    if (window.Telegram && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
}

function closeRouletteModal() {
    rouletteModal.classList.remove('active');
    currentOpenCase = null;
}

function determineWinner(prizes) {
    let totalProbability = prizes.reduce((sum, p) => sum + p.probability, 0);
    if (Math.abs(totalProbability - 1.0) > 0.001 && totalProbability > 0) {
        prizes = prizes.map(p => ({ ...p, probability: p.probability / totalProbability }));
    } else if (totalProbability === 0 && prizes.length > 0) {
        const equalProb = 1 / prizes.length;
        prizes = prizes.map(p => ({ ...p, probability: equalProb }));
    }

    const rand = Math.random();
    let cumulativeProbability = 0;
    for (const prize of prizes) {
        cumulativeProbability += prize.probability;
        if (rand <= cumulativeProbability) {
            return prize;
        }
    }
    return prizes.length > 0 ? prizes[prizes.length - 1] : { name: "Error Prize", floorPrice: 0, tgsFile: "", id: "error" };
}
let spinAnimationTimeout;

async function spinRoulette() {
    if (!currentOpenCase) return;
    clearTimeout(spinAnimationTimeout); 

    if (currentOpenCase.priceTON && currentUser.tonBalance < currentOpenCase.priceTON) {
        showTGNotification("Not enough TON!", 'error'); return;
    }
    if (currentOpenCase.priceStars && currentUser.starBalance < currentOpenCase.priceStars) {
        showTGNotification("Not enough Stars!", 'error'); return;
    }

    if (currentOpenCase.priceTON) currentUser.tonBalance -= currentOpenCase.priceTON;
    if (currentOpenCase.priceStars) currentUser.starBalance -= currentOpenCase.priceStars;
    updateBalances();
    spinButton.disabled = true;
    prizeDisplay.classList.add('hidden');

    const winner = determineWinner(currentOpenCase.prizes);
    
    let spinnerItemsForSpin = [];
    for (let i = 0; i < 70; i++) { 
        spinnerItemsForSpin.push(currentOpenCase.prizes[Math.floor(Math.random() * currentOpenCase.prizes.length)]);
    }
    const winnerVisualIndex = Math.floor(spinnerItemsForSpin.length * 0.85); 
    spinnerItemsForSpin[winnerVisualIndex] = winner;


    rouletteSpinner.innerHTML = ''; 
    spinnerItemsForSpin.forEach(prize => {
        const itemEl = document.createElement('div');
        itemEl.className = 'roulette-item';
         itemEl.innerHTML = `
            <span class="roulette-item-name">${prize.name}</span>
            <span class="roulette-item-value">${prize.floorPrice.toFixed(2)} TON</span>
        `;
        rouletteSpinner.appendChild(itemEl);
    });
    
    const allItemsInSpinner = rouletteSpinner.querySelectorAll('.roulette-item');
    const itemHeight = allItemsInSpinner[0] ? allItemsInSpinner[0].offsetHeight : 60; 
    const rouletteWheelVisibleHeight = rouletteWheel.clientHeight; 

    const landingPosition = (winnerVisualIndex * itemHeight) + (itemHeight / 2) - (rouletteWheelVisibleHeight / 2);

    rouletteSpinner.style.transition = 'none'; 
    rouletteSpinner.style.top = '0px';
    void rouletteSpinner.offsetWidth;

    rouletteSpinner.style.transition = 'top 6s cubic-bezier(0.25, 0.1, 0.2, 1)'; 
    rouletteSpinner.style.top = `-${landingPosition}px`;
    
    if (window.Telegram && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('heavy');

    spinAnimationTimeout = setTimeout(() => {
        wonPrizeName.textContent = winner.name;
        prizeDisplay.classList.remove('hidden');
        spinButton.disabled = false; 

        if (allItemsInSpinner[winnerVisualIndex]) {
            allItemsInSpinner.forEach(el => el.classList.remove('is-winning'));
            allItemsInSpinner[winnerVisualIndex].classList.add('is-winning');
        }

        const inventoryId = `item_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        currentUser.inventory.push({ ...winner, id: inventoryId });
        renderInventory(); 
        showTGNotification(`You got: ${winner.name}!`, 'success'); 
    }, 6100); 
}


// --- Other Page Logic ---
function convertToTon(itemId) {
    const itemIndex = currentUser.inventory.findIndex(invItem => invItem.id === itemId);
    if (itemIndex === -1) return;

    const item = currentUser.inventory[itemIndex];
    currentUser.tonBalance += item.floorPrice;
    currentUser.inventory.splice(itemIndex, 1);

    updateBalances();
    renderInventory();
    showTGNotification(`${item.name} converted to ${item.floorPrice.toFixed(2)} TON!`, 'success');
}

function handleUpgrade() {
    const selectedItemId = upgradeElements.inventorySelect.value;
    if (!selectedItemId) {
        showTGNotification("Please select an item to enhance.", 'error'); return;
    }

    const itemIndex = currentUser.inventory.findIndex(item => item.id === selectedItemId);
    const itemToUpgrade = currentUser.inventory[itemIndex];

    upgradeElements.upgradeResult.textContent = "Enhancing item...";
    upgradeElements.doUpgradeButton.disabled = true;

    setTimeout(() => {
        const success = Math.random() < 0.5; 
        if (success) {
            itemToUpgrade.floorPrice = parseFloat((itemToUpgrade.floorPrice * selectedMultiplier).toFixed(2));
            upgradeElements.upgradeResult.textContent = `Success! ${itemToUpgrade.name} value increased to ${itemToUpgrade.floorPrice.toFixed(2)} TON.`;
            showTGNotification("Enhancement successful!", 'success');
        } else {
            currentUser.inventory.splice(itemIndex, 1); 
            upgradeElements.upgradeResult.textContent = `Failed! ${itemToUpgrade.name} was destroyed. Sent to @Vasiliy939.`;
            showTGNotification("Enhancement failed! Item lost.", 'error');
            console.log(`Item ${itemToUpgrade.name} lost in upgrade, would be sent to Vasiliy939 (TG ID 5146625949)`);
        }
        renderInventory(); 
        upgradeElements.doUpgradeButton.disabled = false;
    }, 2000);
}

function handleDeposit() {
    const amountText = profileElements.depositAmountInput.value;
    if (!amountText.trim()) {
        showTGNotification("Please enter an amount to deposit.", 'warning');
        return;
    }
    const amount = parseFloat(amountText);
    if (isNaN(amount) || amount <= 0) {
        showTGNotification("Please enter a valid positive amount.", 'error');
        return;
    }
    currentUser.tonBalance += amount;
    updateBalances();
    showTGNotification(`${amount.toFixed(2)} TON successfully added to your balance! (Test)`, 'success');
    profileElements.depositAmountInput.value = ''; 
}


// --- Event Listeners ---
appNavButtons.forEach(button => {
    button.addEventListener('click', () => navigateToPage(button.dataset.page));
});

spinButton.addEventListener('click', spinRoulette);
closeRouletteButton.addEventListener('click', closeRouletteModal);

profileElements.confirmDepositButton.addEventListener('click', handleDeposit); 
profileElements.disconnectWalletButton.addEventListener('click', () => {
    currentUser.walletAddress = "Connect Wallet"; 
    renderHeader();
    renderProfile();
    showTGNotification("Wallet Disconnected (Demo).", 'info');
});

upgradeElements.multiplierButtons.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', (e) => {
        selectedMultiplier = parseFloat(e.target.dataset.multiplier);
        upgradeElements.multiplierButtons.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active-multiplier'); // This class now controls primary vs secondary
            if(!btn.classList.contains('button-secondary')) btn.classList.add('button-secondary');
        });
        e.target.classList.add('active-multiplier');
        if(e.target.classList.contains('button-secondary')) e.target.classList.remove('button-secondary');

    });
});
const defaultMultiplierButton = upgradeElements.multiplierButtons.querySelector(`[data-multiplier="${selectedMultiplier}"]`);
if (defaultMultiplierButton) {
    defaultMultiplierButton.classList.add('active-multiplier');
    if(defaultMultiplierButton.classList.contains('button-secondary')) defaultMultiplierButton.classList.remove('button-secondary');
}


upgradeElements.doUpgradeButton.addEventListener('click', handleUpgrade);

inviteElements.copyRefLinkButton.addEventListener('click', () => {
    navigator.clipboard.writeText(inviteElements.referralLink.value)
        .then(() => showTGNotification("Referral Code copied!", 'success'))
        .catch(err => showTGNotification("Failed to copy code.", 'error'));
});
inviteElements.withdrawReferralButton.addEventListener('click', () => {
    if (currentUser.referralEarnings > 0) {
        currentUser.tonBalance += currentUser.referralEarnings;
        currentUser.referralEarnings = 0;
        updateBalances();
        renderInvitePage();
        showTGNotification("Referral Earnings claimed!", 'success');
    } else {
        showTGNotification("No earnings to claim.", 'info');
    }
});


// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand(); 
        try { 
            Telegram.WebApp.setHeaderColor(getComputedStyle(document.documentElement).getPropertyValue('--bg-color-start').trim());
            Telegram.WebApp.setBackgroundColor(getComputedStyle(document.documentElement).getPropertyValue('--bg-color-start').trim());
        } catch (e) {
            console.warn("Could not set Telegram WebApp theme colors.", e);
        }
    } else {
        console.warn("Telegram WebApp SDK not found. Running in browser mode.");
    }

    renderHeader();
    renderCases();
    renderProfile(); 
    renderLeaderboard();
    renderInvitePage();
    navigateToPage('main-page'); 
});
</script>
</body>
</html>
