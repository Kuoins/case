<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TON Gift Universe - Final</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Lottie-Web Player from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <style>
        :root {
            --bg-gradient-start: #1A1D2B; 
            --bg-gradient-mid: #2C2F40;  
            --bg-gradient-end: #121212;   

            --surface-color: #232633; 
            --surface-hover-color: #2E3243;
            
            --primary-color: #0A84FF; 
            --primary-gradient-start: #0A84FF;
            --primary-gradient-end: #34C7F8;   

            --secondary-color: #FF9F0A; 
            
            --text-primary: #FFFFFF;
            --text-secondary: #AEAEB2; 
            --text-placeholder: #636366;

            --border-color: rgba(84, 84, 88, 0.35); 
            --border-highlight: var(--primary-color);

            --danger-color: #FF453A;  
            --success-color: #30D158; 

            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --main-border-radius: 14px; 
            --button-border-radius: 10px;
            --soft-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            font-weight: 500;
            font-size: 15px;
            line-height: 1.45;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        /* Header */
        #app-header {
            padding: 14px 18px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(to right, rgba(30,33,50,0.85), rgba(40,43,60,0.85));
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        #app-header .app-title {
            font-size: 1.4em; 
            font-weight: 800; 
            background: linear-gradient(45deg, var(--primary-gradient-end), var(--text-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #app-header .wallet-info { display: flex; align-items: center; gap: 12px; }
        #app-header .wallet-address, #app-header .balance {
            background-color: var(--surface-hover-color); 
            padding: 7px 14px;
            border-radius: var(--button-border-radius);
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid var(--border-color);
        }
        #app-header .ton-icon {
            width: 18px; height: 18px;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z' fill='%230A84FF'/%3E%3Cpath d='M9.62988 7.51001L8.06988 8.66001C7.82988 8.83001 7.80988 9.17001 8.00988 9.37001L11.6399 13.11C11.8399 13.31 12.1599 13.31 12.3599 13.11L15.9899 9.37001C16.1899 9.17001 16.1699 8.83001 15.9299 8.66001L14.3699 7.51001C14.1499 7.35001 13.8199 7.42001 13.6699 7.63001L12.4299 9.40001C12.1999 9.71001 11.7999 9.71001 11.5699 9.40001L10.3299 7.63001C10.1799 7.42001 9.84988 7.35001 9.62988 7.51001Z' fill='white'/%3E%3Cpath d='M8.00989 14.63L9.75989 16.38C9.93989 16.57 10.2499 16.57 10.4299 16.38L11.5699 15.24C11.7999 15.01 12.1999 15.01 12.4299 15.24L13.5699 16.38C13.7499 16.57 14.0599 16.57 14.2399 16.38L15.9899 14.63C16.1699 14.45 16.1699 14.15 15.9899 13.96L12.4199 10.31C12.1899 10.07 11.7899 10.07 11.5599 10.31L8.00989 13.96C7.80989 14.15 7.80989 14.45 8.00989 14.63Z' fill='white'/%3E%3C/svg%3E");
            background-size: contain; margin-left: 5px; vertical-align: middle;
        }

        /* Content Area */
        #app-content { flex-grow: 1; padding: 20px 16px; overflow-y: auto; padding-bottom: 80px; /* Ensure space for taller nav */ }
        .page { display: none; }
        .page.active { display: block; animation: pageFadeInMinimal 0.3s ease-out; }
        @keyframes pageFadeInMinimal {
            from { opacity: 0; transform: translateY(5px);} 
            to { opacity: 1; transform: translateY(0px);}
        }

        /* Navigation Bar - Updated */
        #app-nav {
            display: flex;
            justify-content: space-around;
            align-items: center; /* Center items vertically */
            background-color: rgba(28, 28, 30, 0.92); 
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border-top: 1px solid var(--border-color);
            padding: 6px 0 8px 0; /* Adjusted padding top/bottom */
            position: sticky; bottom: 0; z-index: 1000;
            min-height: 60px; /* Increased height */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); /* Subtle top shadow */
        }
        .nav-button {
            background: none; border: none;
            color: var(--text-secondary);
            display: flex; flex-direction: column; align-items: center;
            font-size: 11px; /* Slightly larger font */
            font-weight: 500;
            cursor: pointer; padding: 5px; /* Adjusted padding */
            border-radius: var(--button-border-radius);
            transition: color 0.2s, transform 0.1s ease-out;
            flex: 1; text-align: center;
            line-height: 1.3; /* Adjust line height for text */
        }
        .nav-button:active { transform: scale(0.95); }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg {
            width: 26px; height: 26px; /* Larger icons */
            margin-bottom: 3px; /* Slightly more space */
            fill: currentColor;
        }
        .nav-button.active svg { fill: var(--primary-color); }


        /* General UI Elements */
        .button {
            background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
            color: var(--text-primary);
            border: none; padding: 13px 22px; 
            border-radius: var(--button-border-radius);
            font-size: 1.05em; 
            font-weight: 600;
            cursor: pointer;
            transition: filter 0.15s ease-out, transform 0.1s ease-out;
            text-align: center;
            display: block; 
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,122,255,0.2);
        }
        .button:hover { filter: brightness(1.1); }
        .button:active { transform: scale(0.97); filter: brightness(0.9); }
        .button-secondary {
            background-color: var(--surface-hover-color);
            color: var(--primary-color); 
            box-shadow: none;
        }
        .button-secondary:hover { background-color: var(--surface-color); }

        h2 {
            margin-top: 0; font-size: 1.85em; 
            font-weight: 700;
            color: var(--text-primary);
            padding-bottom: 8px; margin-bottom: 24px;
        }
        h3 { 
            font-size: 1.1em; 
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 20px;
            margin-bottom: 12px;
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        .content-card { 
            background-color: var(--surface-color);
            padding: 18px; 
            border-radius: var(--main-border-radius);
            margin-bottom: 18px;
        }


        /* Main Page - Cases */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px; 
        }
        .case-card {
            background-color: var(--surface-color);
            border-radius: var(--main-border-radius);
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            border: 1px solid var(--border-color); 
            overflow: hidden; 
        }
        .case-card:hover {
            background-color: var(--surface-hover-color);
            transform: translateY(-5px);
            box-shadow: var(--soft-shadow);
        }
        .case-card .case-image-display { 
            width: 80px; height: 80px;
            margin: 0 auto 15px auto;
            background-color: var(--surface-hover-color); 
            border-radius: var(--button-border-radius);
            overflow: hidden;
        }
        .case-card .case-image-display img {
            display: block;
            width: 100%; height: 100%;
            object-fit: cover; 
        }
        .case-card .case-name {
            font-weight: 600; font-size: 1em; margin-bottom: 6px;
            color: var(--text-primary);
            min-height: 2.4em; 
            display: flex; align-items: center; justify-content: center;
        }
        .case-card .case-price {
            font-size: 0.9em; font-weight: 500;
            color: var(--text-secondary);
        }

        /* Roulette Modal */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            align-items: center; justify-content: center;
            padding: 16px;
        }
        .modal.active { display: flex; animation: modalFadeInMinimal 0.25s ease-out; }
        .modal-content {
            background-color: var(--surface-color);
            padding: 24px;
            border-radius: var(--main-border-radius);
            width: 100%; max-width: 400px; 
            text-align: center;
            box-shadow: 0 12px 35px rgba(0,0,0,0.35);
            border: 1px solid var(--border-color);
            max-height: 90vh; 
            display: flex; flex-direction: column;
        }
        .modal-content h3 { /* Modal title */
            margin-top: 0; margin-bottom: 16px;
            font-size: 1.35em; font-weight: 700;
            color: var(--text-primary);
        }
        #roulette-wheel-container { 
            width: 100%;
        }
        #roulette-wheel {
            height: 270px; /* TALLER wheel (90px item height * 3) */
            border: 1px solid var(--border-color);
            border-radius: var(--button-border-radius);
            overflow: hidden; position: relative;
            background-color: var(--bg-color); 
            margin: 16px 0 20px 0; 
        }
        #roulette-wheel::before { /* Single Center marker line */
            content: '';
            position: absolute;
            left: 10px; 
            right: 10px;
            top: 50%;
            height: 2px; 
            background-color: var(--primary-color);
            opacity: 0.8;
            transform: translateY(-50%);
            z-index: 2;
            pointer-events: none; 
        }
        #roulette-spinner {
            display: flex; flex-direction: column;
            position: absolute; left: 0; width: 100%;
        }
        .roulette-item {
            height: 90px; /* Height matching wheel / 3 */
            display: flex;
            align-items: center;
            justify-content: center; 
            padding: 0 10px;
            box-sizing: border-box;
            border-bottom: 1px solid var(--border-color);
            overflow: hidden; 
        }
        .roulette-item:last-child { border-bottom: none; }
        .roulette-item img { 
            max-width: 90%;
            max-height: 75px; /* Adjust based on item height */
            object-fit: contain;
        }
        .roulette-item.is-winning img { 
             filter: drop-shadow(0 0 6px var(--primary-color)); /* Slightly bigger glow */
        }

        .modal-actions { margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Prize cards display in modal */
        #possible-prizes-display {
            margin-top: 10px;
            flex-grow: 1; 
            overflow-y: auto;
            padding-right: 5px; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 3 COLUMNS */
            gap: 10px;
        }
        .prize-card {
            background-color: var(--surface-hover-color);
            border-radius: var(--button-border-radius);
            padding: 8px;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center; 
            position: relative; 
            border: 1px solid var(--border-color);
            text-align: center;
            min-height: 100px; 
        }
        .prize-card-image-placeholder { 
            width: 50px; height: 50px;
            background-color: var(--bg-color);
            border-radius: 6px;
            margin-bottom: 6px; 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
         .prize-card-image-placeholder img {
            display: block; width: 100%; height: 100%; object-fit: contain;
         }
        .prize-card-name {
            font-size: 0.8em; 
            font-weight: 500;
            color: var(--text-secondary);
            line-height: 1.2;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; 
        }
        .prize-card-probability {
            position: absolute;
            top: 4px; right: 4px; 
            background-color: var(--primary-color);
            color: var(--text-primary);
            font-size: 0.65em; 
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 4px;
            line-height: 1;
        }

        #prize-display { 
            margin-top: 16px; font-size: 1.2em; font-weight: 600;
            color: var(--success-color);
        }
        #prize-display.hidden { display: none; }
        
        /* Input fields minimal style */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 12px;
            border-radius: var(--button-border-radius);
            background-color: var(--surface-hover-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            font-size: 1em; font-weight: 500;
            box-sizing: border-box;
        }
        input[type="text"]::placeholder, input[type="number"]::placeholder { color: var(--text-placeholder); }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--border-highlight);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); 
        }

        /* Profile Page Specifics */
        .profile-header { text-align: center; margin-bottom: 24px; padding-top: 10px;}
        .profile-avatar-placeholder {
            width: 80px; height: 80px; border-radius: 50%;
            background-color: var(--surface-hover-color);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5em; font-weight: 600; color: var(--text-secondary);
            margin: 0 auto 12px auto;
            border: 2px solid var(--border-color);
        }
        .profile-info .username { font-size: 1.4em; font-weight: 600; margin-bottom: 4px;}
        .profile-info .userid { font-size: 0.9em; color: var(--text-secondary); }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        .inventory-item {
            background-color: var(--surface-hover-color);
            border-radius: var(--button-border-radius);
            padding: 12px; text-align: center;
        }
        .inventory-item-name { font-size: 0.9em; font-weight: 500; margin-bottom: 6px; }
        .inventory-item-value { font-size: 0.8em; color: var(--secondary-color); font-weight: 500; margin-bottom: 8px;}
        .inventory-item-actions .button { font-size: 0.8em; padding: 6px 10px; }
        
        /* Upgrade Page */
        #upgrade-chance-display {
            font-size: 2.5em; font-weight: 700; color: var(--text-primary);
            text-align:center; margin: 20px auto; padding: 15px;
            background-color: var(--surface-hover-color);
            border-radius: 50%; width:100px; height:100px; line-height: 70px;
            border: 3px solid var(--primary-color);
        }
        .multiplier-buttons { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
        .multiplier-buttons button { width: auto; flex-grow: 1; padding: 10px; font-size: 0.9em;}
        .multiplier-buttons button.active-multiplier {
            background: var(--primary-color); 
            color: var(--text-primary);
        }
        
        /* Invite Page */
        .stats-box { display: flex; justify-content: space-around; margin: 20px 0; gap: 12px; }
        .stat-item {
            background-color: var(--surface-hover-color);
            padding: 12px; border-radius: var(--button-border-radius);
            flex: 1; text-align: center;
        }
        .stat-item .value { font-size: 1.5em; font-weight: 600; color: var(--primary-color); }
        .stat-item .label { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; }
        .invited-users-list div { padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em;}
        .invited-users-list div:last-child { border-bottom: none; }

        /* Leaderboard Page */
        .leaderboard-list .leader-entry {
            display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .leaderboard-list .leader-entry:last-child { border-bottom: none; }
        .leader-entry .rank {
            font-weight: 600; font-size: 1em;
            min-width: 30px; text-align: left; color: var(--text-secondary);
        }
        .leader-entry .avatar-placeholder { 
            width: 36px; height: 36px; border-radius: 50%;
            background-color: var(--surface-hover-color); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1em; font-weight: 600; margin: 0 12px;
        }
        .leader-entry .info .name { font-weight: 500; font-size: 1em; }
        .leader-entry .info .details { font-size: 0.8em; color: var(--text-secondary); }
        .leader-entry .score {
            margin-left: auto; font-weight: 600; font-size: 1em;
            color: var(--text-primary);
        }
         .leader-entry.current-user-entry .info .name {
             color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div id="app-container">
         <header id="app-header">
            <div class="app-title">Gift Universe</div>
            <div class="wallet-info">
                <div id="wallet-address" class="wallet-address">Connect Wallet</div>
                <div id="balance" class="balance">
                    <span id="ton-balance">0.00</span> <span class="ton-icon"></span>
                </div>
            </div>
        </header>

        <main id="app-content">
            <div id="main-page" class="page active">
                <h2>Cases</h2>
                <div id="cases-grid" class="cases-grid">
                    <!-- Cases will be dynamically inserted here -->
                </div>
            </div>

             <div id="upgrade-page" class="page">
                <h2>Upgrade Item</h2> 
                <div class="content-card">
                    <p style="text-align:center; margin-bottom:15px; color: var(--text-secondary);">Select an item from your collection:</p>
                    <select id="upgrade-inventory-select">
                        <option value="">-- Choose Item --</option>
                    </select>
                    <div id="upgrade-chance-display">50%</div> 
                     <p style="text-align:center; margin-bottom:10px; color: var(--text-secondary);">Multiplier:</p>
                    <div id="multiplier-buttons" class="multiplier-buttons">
                        <button class="button button-secondary" data-multiplier="1.5" data-chance="50">x1.5</button>
                        <button class="button button-secondary" data-multiplier="2" data-chance="35">x2</button>
                        <button class="button button-secondary" data-multiplier="3" data-chance="25">x3</button>
                        <button class="button button-secondary" data-multiplier="5" data-chance="15">x5</button>
                        <button class="button button-secondary" data-multiplier="10" data-chance="8">x10</button>
                        <button class="button button-secondary" data-multiplier="20" data-chance="3">x20</button>
                    </div>
                    <button id="do-upgrade-button" class="button">Attempt Upgrade</button>
                    <p id="upgrade-result" style="margin-top: 15px; font-weight: 500; text-align:center;"></p>
                </div>
            </div>

            <div id="invite-page" class="page">
                <h2>Referrals</h2>
                 <div class="content-card">
                    <p style="font-size: 1em; margin-bottom: 15px; text-align:center; color:var(--text-secondary);">Invite friends and earn <strong>10%</strong> of their deposits!</p>
                    <input type="text" id="referral-link" value="https://t.me/YourAppBot?start=ref_USER123" readonly>
                    <button id="copy-ref-link-button" class="button" style="margin-bottom: 20px;">Copy Referral Code</button>
                    
                    <div class="stats-box" style="margin-bottom: 20px;">
                        <div class="stat-item">
                            <div id="referral-balance" class="value">0.00 <span class="ton-icon"></span></div>
                            <div class="label">Referral Earnings</div>
                        </div>
                        <div class="stat-item">
                            <div id="invited-count" class="value">0</div>
                            <div class="label">Friends Invited</div>
                        </div>
                    </div>
                    <button id="withdraw-referral-button" class="button button-secondary">Withdraw Earnings</button>
                </div>
                <div class="content-card">
                    <h3>Invited Friends (Demo)</h3>
                    <div class="invited-users-list">
                        <div>User_Alpha7 - Profit: 1.5 TON</div>
                        <div>User_BetaMax - Profit: 0.5 TON</div>
                    </div>
                </div>
            </div>


            <div id="leaderboard-page" class="page">
                <h2>Leaderboard</h2>
                <div id="leaderboard-list" class="leaderboard-list content-card" style="padding-top:0; padding-bottom:0;">
                    <!-- Leaderboard entries -->
                </div>
            </div>

            <div id="profile-page" class="page">
                <div class="profile-header">
                    <div id="profile-avatar" class="profile-avatar-placeholder">V</div>
                    <div class="profile-info">
                        <div id="profile-username" class="username">Vasiliy</div>
                        <div id="profile-userid" class="userid">#5146625949</div>
                    </div>
                </div>

                <div class="content-card">
                    <h3>Balance</h3>
                    <div id="profile-balance-display" style="font-size:1.6em; font-weight:600; margin-bottom:10px;">100.00 <span class="ton-icon"></span></div>
                    <input type="number" id="deposit-amount-input" placeholder="Amount in TON" style="margin-bottom: 10px;">
                    <button id="confirm-deposit-button" class="button">Deposit TON (Test)</button>
                </div>

                <div class="content-card">
                     <h3>Wallet</h3>
                    <div id="profile-wallet-address" style="color:var(--text-secondary); margin-bottom:10px; word-break:break-all;">UQBoR...3064 (Demo)</div>
                    <button id="disconnect-wallet-button" class="button button-secondary">Disconnect Wallet</button>
                </div>

                <div class="content-card">
                    <h3>My Collection (<span id="inventory-count">0</span>)</h3>
                    <div id="inventory-grid" class="inventory-grid">
                        <p id="empty-inventory-message" style="grid-column: 1 / -1; text-align: center; color: var(--text-placeholder); padding:15px 0;">Your collection is empty.</p>
                        <!-- Inventory items will be here -->
                    </div>
                </div>
            </div>
        </main>

        <nav id="app-nav">
             <button class="nav-button active" data-page="main-page">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                Cases
            </button>
            <button class="nav-button" data-page="upgrade-page">
                 <svg viewBox="0 0 24 24"><path d="M9.48 5.55L6.91 8.12L5.5 6.71L9.48 2.73L13.47 6.71L12.06 8.12L9.48 5.55M9.48 5.55V13.75C9.48 14.15 9.15 14.48 8.75 14.48C8.35 14.48 8.02 14.15 8.02 13.75V5.55L5.45 8.12L4.04 6.71L8.02 2.73L12.01 6.71L10.6 8.12L8.02 5.55M15.25 10.25C14.85 10.25 14.52 10.58 14.52 10.98V19.18L11.95 16.61L10.54 18L14.52 21.99L18.5 18L17.09 16.61L14.52 19.18V10.98C14.52 10.58 14.19 10.25 13.79 10.25H15.25Z"/></svg>
                Upgrade 
            </button>
            <button class="nav-button" data-page="invite-page">
                 <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                Referrals
            </button>
            <button class="nav-button" data-page="leaderboard-page">
                <svg viewBox="0 0 24 24"><path d="M16,1H4C2.89,1 2,1.89 2,3V17H4V3H16V1M16.5,5H7.5C6.67,5 6,5.67 6,6.5V22.5L12,19.5L18,22.5V6.5C18,5.67 17.33,5 16.5,5M14,11H10V9H14V11M14,15H10V13H14V15Z" /></svg>
                Leaders
            </button>
            <button class="nav-button" data-page="profile-page">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                Profile
            </button>
        </nav>
    </div>

    <!-- Roulette Modal -->
    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <h3 id="roulette-case-name">Opening Case...</h3>
            <div id="roulette-wheel-container">
                <div id="roulette-wheel">
                    <div id="roulette-spinner">
                        <!-- Prize images will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="modal-actions"> 
                <button id="spin-button" class="button">Spin</button>
                <button id="close-roulette-button" class="button button-secondary">Close</button>
            </div>
            <div id="prize-display" class="hidden"> 
                You got: <span id="won-prize-name"></span>!
            </div>
             <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">
             <!-- Title for possible prizes -->
             <h4 style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 500;">Possible Prizes:</h4>
            <div id="possible-prizes-display">
                 <!-- Possible prize cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

<script>
// --- Constants and Global State ---
const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/GiftImages/';

const currentUser = {
    id: '5146625949',
    username: 'Vasiliy',
    walletAddress: 'UQBoR...3064', 
    tonBalance: 100.00,
    starBalance: 2000,
    inventory: [],
    referralCode: 'ref_VASILIY123',
    referralEarnings: 0,
    invitedUsersCount: 2
};

let currentOpenCase = null;
let selectedMultiplier = 1.5;
const upgradeChances = { 
    1.5: 50, 2: 35, 3: 25, 5: 15, 10: 8, 20: 3
};

// Function to generate image filename from prize/case name
function generateImageFilename(name) {
    if (name === "Durov's Cap") return "Durov's-Cap.png"; 
    if (name === "Kissed Frog Happy Pepe") return "Kissed-Frog-Happy-Pepe.png"; // Corrected filename
    if (name === "Vintage Cigar") return "Vintage-CIgar.png"; 
    // General rule: replace spaces with hyphens, keep case mostly, add .png
    return name.replace(/\s+/g, '-').replace(/&/g, 'and') + '.png'; 
}

// EMOJIS REMOVED, imageFilename added/completed for ALL prizes
const casesData = [
    // REGULAR CASE REMOVED
    { 
        id: 'lolpop', name: 'Lol Pop Stash', imageFilename: generateImageFilename('Lol Pop'), priceTON: 0.5,
        prizes: [
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.01 },
            { name: 'Party Sparkler', imageFilename: generateImageFilename('Party Sparkler'), floorPrice: 1, probability: 0.10 },
            { name: 'B-Day Candle', imageFilename: generateImageFilename('B-Day Candle'), floorPrice: 0.7, probability: 0.10 },
            { name: 'Homemade Cake', imageFilename: generateImageFilename('Homemade Cake'), floorPrice: 1, probability: 0.09 },
            { name: 'Lol Pop', imageFilename: generateImageFilename('Lol Pop'), floorPrice: 0.7, probability: 0.20 },
            { name: 'Hynpo Lollipop', imageFilename: generateImageFilename('Hynpo Lollipop'), floorPrice: 0.7, probability: 0.20 },
            { name: 'Desk Calendar', imageFilename: generateImageFilename('Desk Calendar'), floorPrice: 0.7, probability: 0.10 },
            { name: 'Cookie Heart', imageFilename: generateImageFilename('Cookie Heart'), floorPrice: 0.9, probability: 0.10 },
            { name: 'Jack-in-the-box', imageFilename: generateImageFilename('Jack-in-the-box'), floorPrice: 1, probability: 0.08 },
            { name: 'Skull Flower', imageFilename: generateImageFilename('Skull Flower'), floorPrice: 1.7, probability: 0.02 },
        ]
    },
    { 
        id: 'recordplayer', name: 'Record Player Vault', imageFilename: generateImageFilename('Record Player'), priceTON: 3,
        prizes: [
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.50 },
            { name: 'Lol Pop', imageFilename: generateImageFilename('Lol Pop'), floorPrice: 0.7, probability: 0.08 },
            { name: 'Hynpo Lollipop', imageFilename: generateImageFilename('Hynpo Lollipop'), floorPrice: 0.7, probability: 0.08 },
            { name: 'Party Sparkler', imageFilename: generateImageFilename('Party Sparkler'), floorPrice: 1, probability: 0.08 },
            { name: 'Skull Flower', imageFilename: generateImageFilename('Skull Flower'), floorPrice: 1.7, probability: 0.08 },
            { name: 'Jelly Bunny', imageFilename: generateImageFilename('Jelly Bunny'), floorPrice: 1.8, probability: 0.08 },
            { name: 'Tama Gadget', imageFilename: generateImageFilename('Tama Gadget'), floorPrice: 2, probability: 0.05 },
            { name: 'Snow Globe', imageFilename: generateImageFilename('Snow Globe'), floorPrice: 2, probability: 0.05 },
        ]
    },
    { 
        id: 'swisswatch', name: 'Swiss Watch Box', imageFilename: generateImageFilename('Swiss Watch'), priceTON: 5,
        prizes: [
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.20 },
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.10 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.15 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.15 },
            { name: 'Voodoo Doll', imageFilename: generateImageFilename('Voodoo Doll'), floorPrice: 4.2, probability: 0.10 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.10 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.05 },
        ]
    },
    { 
        id: 'perfumebottle', name: 'Perfume Chest', imageFilename: generateImageFilename('Perfume Bottle'), priceTON: 10,
        prizes: [
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.10 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.15 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.20 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.15 },
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.10 },
            { name: 'Kissed Frog', imageFilename: generateImageFilename('Kissed Frog'), floorPrice: 9, probability: 0.10 },
            { name: 'Loot Bag', imageFilename: generateImageFilename('Loot Bag'), floorPrice: 12, probability: 0.05 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.10 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.05 },
        ]
    },
    { 
        id: 'vintagecigar', name: 'Vintage Cigar Safe', imageFilename: generateImageFilename('Vintage Cigar'), priceTON: 20,
        prizes: [
            { name: 'Vintage Cigar', imageFilename: generateImageFilename('Vintage Cigar'), floorPrice: 13, probability: 0.10 },
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.15 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.20 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.15 },
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.15 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.10 },
            { name: 'Mini Oscar', imageFilename: generateImageFilename('Mini Oscar'), floorPrice: 18, probability: 0.08 },
            { name: 'Scared Cat', imageFilename: generateImageFilename('Scared Cat'), floorPrice: 17, probability: 0.07 },
        ]
    },
    { 
        id: 'astralshard', name: 'Astral Shard Relic', imageFilename: generateImageFilename('Astral Shard'), priceTON: 50,
        prizes: [
            { name: 'Astral Shard', imageFilename: generateImageFilename('Astral Shard'), floorPrice: 60, probability: 0.10 },
            { name: 'Vintage Cigar', imageFilename: generateImageFilename('Vintage Cigar'), floorPrice: 13, probability: 0.15 },
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.15 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.10 },
            { name: 'Precious Peach', imageFilename: generateImageFilename('Precious Peach'), floorPrice: 60, probability: 0.10 },
            { name: 'Mini Oscar', imageFilename: generateImageFilename('Mini Oscar'), floorPrice: 18, probability: 0.15 },
            { name: 'Scared Cat', imageFilename: generateImageFilename('Scared Cat'), floorPrice: 17, probability: 0.10 },
            { name: 'Loot Bag', imageFilename: generateImageFilename('Loot Bag'), floorPrice: 12, probability: 0.05 },
        ]
    },
    { 
        id: 'plushpepe', name: 'Plush Pepe Hoard', imageFilename: generateImageFilename('Plush Pepe'), priceTON: 100,
        prizes: [
            { name: 'Plush Pepe', imageFilename: generateImageFilename('Plush Pepe'), floorPrice: 560, probability: 0.10 },
            { name: 'Durov\'s Cap', imageFilename: generateImageFilename('Durov\'s Cap'), floorPrice: 150, probability: 0.50 },
            { name: 'Astral Shard', imageFilename: generateImageFilename('Astral Shard'), floorPrice: 60, probability: 0.40 },
        ]
    },
    { 
        id: 'happypepe', name: 'Happy Pepe Treasure', imageFilename: generateImageFilename('Happy Pepe Kissed Frog'), priceTON: 600,
        prizes: [
            { name: 'Kissed Frog Happy Pepe', imageFilename: generateImageFilename('Happy Pepe Kissed Frog'), floorPrice: 660, probability: 0.3636 },
            { name: 'Plush Pepe', imageFilename: generateImageFilename('Plush Pepe'), floorPrice: 560, probability: 0.6364 },
        ]
    },
    { 
        id: 'amber', name: 'Amber Nebula Case', imageFilename: 'Amber.png', priceTON: 3, // Placeholder image name
        prizes: [
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.01 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.03 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.10 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.15 },
            { name: 'Voodoo Doll', imageFilename: generateImageFilename('Voodoo Doll'), floorPrice: 4.2, probability: 0.15 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.15 },
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.08 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.08 },
            { name: 'Sakura Flower', imageFilename: generateImageFilename('Sakura Flower'), floorPrice: 2, probability: 0.08 },
            { name: 'Jelly Bunny', imageFilename: generateImageFilename('Jelly Bunny'), floorPrice: 1.8, probability: 0.06 },
            { name: 'Skull Flower', imageFilename: generateImageFilename('Skull Flower'), floorPrice: 1.7, probability: 0.06 },
        ]
    },
    { 
        id: 'midnightblue', name: 'Midnight Blue Comet', imageFilename: 'Midnight-Blue.png', priceTON: 3, // Placeholder
        prizes: [
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.01 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.03 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.06 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.10 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.15 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.15 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.15 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.08 },
            { name: 'Tama Gadget', imageFilename: generateImageFilename('Tama Gadget'), floorPrice: 2, probability: 0.08 },
            { name: 'Snow Globe', imageFilename: generateImageFilename('Snow Globe'), floorPrice: 2, probability: 0.08 },
            { name: 'Sleigh Bell', imageFilename: generateImageFilename('Sleigh Bell'), floorPrice: 2, probability: 0.06 },
            { name: 'Candy Cane', imageFilename: generateImageFilename('Candy Cane'), floorPrice: 0.9, probability: 0.05 },
        ]
    },
    { 
        id: 'onyxblack', name: 'Onyx Black Hole', imageFilename: 'Onyx-Black.png', priceTON: 5, // Placeholder
        prizes: [
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.01 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.03 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.05 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.10 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.15 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.15 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.15 },
            { name: 'Voodoo Doll', imageFilename: generateImageFilename('Voodoo Doll'), floorPrice: 4.2, probability: 0.10 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.08 },
            { name: 'Toy Bear', imageFilename: generateImageFilename('Toy Bear'), floorPrice: 5.2, probability: 0.08 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.05 },
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.05 },
        ]
    },
    { 
        id: 'black', name: 'BLACK Singularity', imageFilename: 'BLACK.png', priceTON: 15, // Placeholder
        prizes: [
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.01 },
            { name: 'Mini Oscar', imageFilename: generateImageFilename('Mini Oscar'), floorPrice: 18, probability: 0.03 },
            { name: 'Scared Cat', imageFilename: generateImageFilename('Scared Cat'), floorPrice: 17, probability: 0.05 },
            { name: 'Vintage Cigar', imageFilename: generateImageFilename('Vintage Cigar'), floorPrice: 13, probability: 0.10 },
            { name: 'Loot Bag', imageFilename: generateImageFilename('Loot Bag'), floorPrice: 12, probability: 0.15 },
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.15 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.15 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.10 },
            { name: 'Kissed Frog', imageFilename: generateImageFilename('Kissed Frog'), floorPrice: 9, probability: 0.08 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.03 },
        ]
    },
];


// --- Image Preloader ---
const imageUrlsToPreload = [];
casesData.forEach(caseItem => {
    if (caseItem.imageFilename) {
        imageUrlsToPreload.push(IMAGE_BASE_URL + caseItem.imageFilename);
    }
    caseItem.prizes.forEach(prize => {
        if (prize.imageFilename && !imageUrlsToPreload.includes(IMAGE_BASE_URL + prize.imageFilename)) {
             imageUrlsToPreload.push(IMAGE_BASE_URL + prize.imageFilename);
        }
    });
});

function preloadImages(urls) {
    urls.forEach(url => {
        const img = new Image();
        img.src = url;
    });
}
// ----------------------


// --- DOM Elements --- 
const appHeader = {
    walletAddress: document.getElementById('wallet-address'),
    tonBalance: document.getElementById('ton-balance'),
};
const appNavButtons = document.querySelectorAll('.nav-button');
const pages = document.querySelectorAll('.page');
const casesGrid = document.getElementById('cases-grid');

const rouletteModal = document.getElementById('roulette-modal');
const rouletteCaseName = document.getElementById('roulette-case-name');
const rouletteWheel = document.getElementById('roulette-wheel');
const rouletteSpinner = document.getElementById('roulette-spinner');
const prizeDisplay = document.getElementById('prize-display');
const wonPrizeName = document.getElementById('won-prize-name');
const spinButton = document.getElementById('spin-button');
const closeRouletteButton = document.getElementById('close-roulette-button');
const possiblePrizesDisplay = document.getElementById('possible-prizes-display'); 

const profileElements = {
    avatar: document.getElementById('profile-avatar'),
    username: document.getElementById('profile-username'),
    userid: document.getElementById('profile-userid'),
    balanceDisplay: document.getElementById('profile-balance-display'),
    walletAddress: document.getElementById('profile-wallet-address'),
    inventoryGrid: document.getElementById('inventory-grid'),
    inventoryCount: document.getElementById('inventory-count'),
    emptyInventoryMessage: document.getElementById('empty-inventory-message'),
    disconnectWalletButton: document.getElementById('disconnect-wallet-button'),
    depositAmountInput: document.getElementById('deposit-amount-input'),
    confirmDepositButton: document.getElementById('confirm-deposit-button')
};

const upgradeElements = {
    inventorySelect: document.getElementById('upgrade-inventory-select'),
    multiplierButtons: document.getElementById('multiplier-buttons'),
    doUpgradeButton: document.getElementById('do-upgrade-button'),
    upgradeResult: document.getElementById('upgrade-result'),
    chanceDisplay: document.getElementById('upgrade-chance-display') 
};

const inviteElements = {
    referralLink: document.getElementById('referral-link'),
    copyRefLinkButton: document.getElementById('copy-ref-link-button'),
    referralBalance: document.getElementById('referral-balance'),
    invitedCount: document.getElementById('invited-count'),
    withdrawReferralButton: document.getElementById('withdraw-referral-button')
};

const leaderboardList = document.getElementById('leaderboard-list');


// --- Utility Functions ---
function updateBalances() {
    appHeader.tonBalance.textContent = currentUser.tonBalance.toFixed(2);
    profileElements.balanceDisplay.innerHTML = `${currentUser.tonBalance.toFixed(2)} <span class="ton-icon"></span>`;
}

function navigateToPage(pageId) {
    pages.forEach(page => page.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    appNavButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === pageId);
    });
    window.scrollTo(0, 0); 
}

function showTGNotification(message, type = 'info') { 
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.showAlert) {
        Telegram.WebApp.showAlert(message);
    } else {
        alert(message); 
    }
    if (window.Telegram && Telegram.WebApp.HapticFeedback) {
        if (type === 'success') Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        else if (type === 'error') Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        else if (type === 'warning') Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
    }
}

// --- Rendering Functions ---
function renderHeader() {
    if (currentUser.walletAddress && currentUser.walletAddress !== "Connect Wallet") {
        appHeader.walletAddress.textContent = currentUser.walletAddress.substring(0, 5) + '...' + currentUser.walletAddress.substring(currentUser.walletAddress.length - 4);
        appHeader.walletAddress.onclick = null; 
    } else {
        appHeader.walletAddress.textContent = "Connect Wallet";
        appHeader.walletAddress.onclick = () => {
            currentUser.walletAddress = "UQDemoWalletAddrLongSampleText12345"; 
            renderHeader();
            showTGNotification("Wallet Connected (Demo)!", 'success');
        };
    }
    updateBalances();
}

function renderCases() {
    casesGrid.innerHTML = '';
    casesData.forEach(caseItem => {
        const card = document.createElement('div');
        card.className = 'case-card';
        card.onclick = () => openRouletteModal(caseItem);

        const imageContainer = document.createElement('div');
        imageContainer.className = 'case-image-display';
        const img = document.createElement('img');
        // Use case image or default if not specified
        const caseImageUrl = caseItem.imageFilename ? IMAGE_BASE_URL + caseItem.imageFilename : 'placeholder.png'; // Add a placeholder image URL if needed
        img.src = caseImageUrl; 
        img.alt = caseItem.name;
        img.loading = 'lazy'; // Improve initial load performance
        img.onerror = (e) => { 
            e.target.style.display='none'; 
            imageContainer.textContent = '🎁'; // Fallback emoji
            imageContainer.style.fontSize='2.5em'; 
            imageContainer.style.display='flex';
            imageContainer.style.alignItems='center';
            imageContainer.style.justifyContent='center';
        } 
        imageContainer.appendChild(img);

        const name = document.createElement('div');
        name.className = 'case-name';
        name.textContent = caseItem.name; 

        const price = document.createElement('div');
        price.className = 'case-price';
        let priceText = '';
        if (caseItem.priceTON) priceText += `${caseItem.priceTON.toFixed(1)} TON `;
        if (caseItem.priceStars) priceText += (priceText ? '/ ' : '') + `${caseItem.priceStars} ✨`;
        price.textContent = priceText || 'Free';

        card.appendChild(imageContainer);
        card.appendChild(name);
        card.appendChild(price);
        casesGrid.appendChild(card);
    });
}

function renderProfile() {
    profileElements.avatar.textContent = currentUser.username ? currentUser.username.charAt(0).toUpperCase() : 'U';
    profileElements.username.textContent = currentUser.username || 'User';
    profileElements.userid.textContent = currentUser.id ? `#${currentUser.id}` : '';
    profileElements.walletAddress.textContent = (currentUser.walletAddress && currentUser.walletAddress !== "Connect Wallet") ? currentUser.walletAddress : 'Not Connected';
    renderInventory();
}

function renderInventory() {
    profileElements.inventoryGrid.innerHTML = '';
    if (currentUser.inventory.length === 0) {
        profileElements.emptyInventoryMessage.style.display = 'block';
    } else {
        profileElements.emptyInventoryMessage.style.display = 'none';
        currentUser.inventory.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item';
            itemDiv.innerHTML = `
                <div class="inventory-item-name" title="${item.name}">${item.name}</div>
                <div class="inventory-item-value">${item.floorPrice.toFixed(2)} TON</div>
                <div class="inventory-item-actions">
                    <button class="button button-secondary" onclick="convertToTon('${item.id}')">Convert</button>
                </div>
            `;
            profileElements.inventoryGrid.appendChild(itemDiv);
        });
    }
    profileElements.inventoryCount.textContent = currentUser.inventory.length;
    populateUpgradeInventorySelect();
}

function populateUpgradeInventorySelect() {
    upgradeElements.inventorySelect.innerHTML = '<option value="">-- Choose Item --</option>';
    currentUser.inventory.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = `${item.name} (${item.floorPrice.toFixed(2)} TON)`;
        upgradeElements.inventorySelect.appendChild(option);
    });
}

function renderLeaderboard() {
    leaderboardList.innerHTML = ''; 
    const leaders = [ 
        { rank: 1, name: 'NovaPrime', avatarChar: 'N', opened: 250, income: 1850.5 },
        { rank: 2, name: 'Starlord77', avatarChar: 'S', opened: 220, income: 1580.2 },
        { rank: 3, name: 'GalaxyGlider', avatarChar: 'G', opened: 300, income: 1250.0 },
        { rank: 4, name: 'CometChaser', avatarChar: 'C', opened: 190, income: 900.7 },
        { rank: 5, name: currentUser.username, avatarChar: currentUser.username.charAt(0), opened: 10, income: Math.max(0, currentUser.tonBalance - 100 + currentUser.inventory.reduce((sum, item) => sum + item.floorPrice, 0)), isCurrentUser: true },
    ].sort((a, b) => b.income - a.income).map((leader, index) => ({...leader, rank: index + 1})); 

    leaders.forEach(leader => {
        const entry = document.createElement('div');
        entry.className = 'leader-entry';
        if (leader.isCurrentUser) entry.classList.add('current-user-entry');
        entry.innerHTML = `
            <div class="rank">#${leader.rank}</div>
            <div class="avatar-placeholder">${leader.avatarChar}</div>
            <div class="info">
                <div class="name">${leader.name}</div>
                <div class="details">Opened ${leader.opened} cases</div>
            </div>
            <div class="score">${leader.income.toFixed(1)} <span class="ton-icon"></span></div>
        `;
        leaderboardList.appendChild(entry);
    });
}

function renderInvitePage() {
    inviteElements.referralLink.value = `https://t.me/YourAppBot?start=${currentUser.referralCode}`;
    inviteElements.referralBalance.innerHTML = `${currentUser.referralEarnings.toFixed(2)} <span class="ton-icon"></span>`;
    inviteElements.invitedCount.textContent = currentUser.invitedUsersCount;
}


// --- Roulette Logic ---
function openRouletteModal(caseItem) {
    currentOpenCase = caseItem;
    if (!currentOpenCase || !currentOpenCase.prizes) {
        showTGNotification("Error loading case data.", "error");
        return;
    }

    rouletteCaseName.textContent = caseItem.name; 
    spinButton.textContent = `Spin (${caseItem.priceTON ? caseItem.priceTON.toFixed(1) + ' TON' : ''} ${caseItem.priceStars && caseItem.priceTON ? '/' : ''} ${caseItem.priceStars ? caseItem.priceStars + ' ✨' : ''})`;
    spinButton.disabled = false;
    prizeDisplay.classList.add('hidden');
    wonPrizeName.textContent = '';
    rouletteSpinner.innerHTML = ''; 
    rouletteSpinner.style.transition = 'none'; 
    rouletteSpinner.style.top = '0px'; 

    // Populate wheel (images)
    let spinnerItemsContent = [];
    for (let i = 0; i < 80; i++) { 
        spinnerItemsContent.push(currentOpenCase.prizes[Math.floor(Math.random() * currentOpenCase.prizes.length)]);
    }
    spinnerItemsContent.forEach(prize => {
        if (!prize) return; // Safety check
        const itemEl = document.createElement('div');
        itemEl.className = 'roulette-item';
        const img = document.createElement('img');
        img.src = prize.imageFilename ? IMAGE_BASE_URL + prize.imageFilename : '';
        img.alt = prize.name || 'Prize';
        img.loading = 'lazy';
        img.onerror = (e) => { e.target.style.display='none'; itemEl.textContent = '?'; itemEl.style.fontSize='2em'; } 
        itemEl.appendChild(img);
        rouletteSpinner.appendChild(itemEl);
    });

    // Populate possible prizes display (cards with images and probability)
    possiblePrizesDisplay.innerHTML = '';
    const prizeMap = new Map();
    currentOpenCase.prizes.forEach(p => {
        if(!p || !p.name) return; // More safety checks
        if (prizeMap.has(p.name)) {
            prizeMap.set(p.name, { 
                ...prizeMap.get(p.name), 
                probability: prizeMap.get(p.name).probability + p.probability 
            });
        } else {
            prizeMap.set(p.name, { ...p }); 
        }
    });

    prizeMap.forEach((prizeData, name) => {
        if (!prizeData) return; // Safety check
        const probability = prizeData.probability || 0; 
        const prizeCard = document.createElement('div');
        prizeCard.className = 'prize-card';
        
        const imgContainer = document.createElement('div');
        imgContainer.className = 'prize-card-image-placeholder';
        const img = document.createElement('img');
        img.src = prizeData.imageFilename ? IMAGE_BASE_URL + prizeData.imageFilename : '';
        img.alt = name;
        img.loading = 'lazy';
        img.onerror = (e) => { e.target.style.display='none'; imgContainer.textContent = '?';} 
        imgContainer.appendChild(img);

        prizeCard.innerHTML = `
            <span class="prize-card-probability">${(probability * 100).toFixed(probability < 0.01 ? 3 : (probability < 0.1 ? 2 : 1) )}%</span> 
            <span class="prize-card-name">${name}</span>
        `; 
        prizeCard.insertBefore(imgContainer, prizeCard.firstChild); 
        possiblePrizesDisplay.appendChild(prizeCard);
    });


    rouletteModal.classList.add('active');
    if (window.Telegram && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
}

function closeRouletteModal() {
    rouletteModal.classList.remove('active');
    currentOpenCase = null;
}

function determineWinner(prizes) {
    if(!prizes || prizes.length === 0) return { name: "Error Prize", floorPrice: 0, imageFilename: "", id: "error" }; // Handle empty prizes

    // Normalization logic 
    let totalProbability = prizes.reduce((sum, p) => sum + (p.probability || 0), 0);
    let normalizedPrizes = prizes;

    if (Math.abs(totalProbability - 1.0) > 0.001 && totalProbability > 0) {
        normalizedPrizes = prizes.map(p => ({ ...p, probability: (p.probability || 0) / totalProbability }));
    } else if (totalProbability === 0) {
        const equalProb = 1 / prizes.length;
        normalizedPrizes = prizes.map(p => ({ ...p, probability: equalProb }));
    }

    const rand = Math.random();
    let cumulativeProbability = 0;
    for (const prize of normalizedPrizes) {
        cumulativeProbability += prize.probability;
        if (rand <= cumulativeProbability) {
            return prize;
        }
    }
    // Fallback
    return normalizedPrizes[normalizedPrizes.length - 1]; 
}
let spinAnimationTimeout;

async function spinRoulette() {
    if (!currentOpenCase) return;
    clearTimeout(spinAnimationTimeout); 

    if (currentOpenCase.priceTON && currentUser.tonBalance < currentOpenCase.priceTON) {
        showTGNotification("Not enough TON!", 'error'); return;
    }
    if (currentOpenCase.priceStars && currentUser.starBalance < currentOpenCase.priceStars) {
        showTGNotification("Not enough Stars!", 'error'); return;
    }

    if (currentOpenCase.priceTON) currentUser.tonBalance -= currentOpenCase.priceTON;
    if (currentOpenCase.priceStars) currentUser.starBalance -= currentOpenCase.priceStars;
    updateBalances();
    spinButton.disabled = true;
    prizeDisplay.classList.add('hidden');

    const winner = determineWinner(currentOpenCase.prizes);
     if (!winner || winner.id === "error") {
        showTGNotification("Error determining prize. Please try again.", "error");
        spinButton.disabled = false;
        return;
    }
    
    let spinnerItemsForSpin = [];
    for (let i = 0; i < 70; i++) { 
        spinnerItemsForSpin.push(currentOpenCase.prizes[Math.floor(Math.random() * currentOpenCase.prizes.length)]);
    }
    const winnerVisualIndex = Math.floor(spinnerItemsForSpin.length * 0.85); 
    spinnerItemsForSpin[winnerVisualIndex] = winner;


    rouletteSpinner.innerHTML = ''; 
    spinnerItemsForSpin.forEach(prize => {
        if (!prize) return; // Safety check
        const itemEl = document.createElement('div');
        itemEl.className = 'roulette-item';
        const img = document.createElement('img');
        img.src = prize.imageFilename ? IMAGE_BASE_URL + prize.imageFilename : '';
        img.alt = prize.name || 'Prize';
        img.loading = 'lazy';
        img.onerror = (e) => { e.target.style.display='none'; itemEl.textContent = '?'; itemEl.style.fontSize='2em'; } 
        itemEl.appendChild(img);
        rouletteSpinner.appendChild(itemEl);
    });
    
    const allItemsInSpinner = rouletteSpinner.querySelectorAll('.roulette-item');
    if (allItemsInSpinner.length === 0) { // Prevent error if spinner is empty
        showTGNotification("Error setting up roulette.", "error");
        spinButton.disabled = false;
        return;
    }
    const itemHeight = allItemsInSpinner[0].offsetHeight; 
    const rouletteWheelVisibleHeight = rouletteWheel.clientHeight; 

    const landingPosition = (winnerVisualIndex * itemHeight) + (itemHeight / 2) - (rouletteWheelVisibleHeight / 2);

    rouletteSpinner.style.transition = 'none'; 
    rouletteSpinner.style.top = '0px';
    void rouletteSpinner.offsetWidth;

    rouletteSpinner.style.transition = 'top 6s cubic-bezier(0.25, 0.1, 0.2, 1)'; 
    rouletteSpinner.style.top = `-${landingPosition}px`;
    
    if (window.Telegram && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('heavy');

    spinAnimationTimeout = setTimeout(() => {
        wonPrizeName.textContent = winner.name;
        prizeDisplay.classList.remove('hidden');
        spinButton.disabled = false; 

        if (allItemsInSpinner[winnerVisualIndex]) {
            allItemsInSpinner.forEach(el => el.classList.remove('is-winning'));
            allItemsInSpinner[winnerVisualIndex].classList.add('is-winning');
        }

        const inventoryId = `item_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        currentUser.inventory.push({ 
            ...winner, 
            id: inventoryId 
        });
        renderInventory(); 
        showTGNotification(`You got: ${winner.name}!`, 'success'); 
    }, 6100); 
}


// --- Other Page Logic ---
function convertToTon(itemId) {
    const itemIndex = currentUser.inventory.findIndex(invItem => invItem.id === itemId);
    if (itemIndex === -1) return;

    const item = currentUser.inventory[itemIndex];
    currentUser.tonBalance += item.floorPrice;
    currentUser.inventory.splice(itemIndex, 1);

    updateBalances();
    renderInventory();
    showTGNotification(`${item.name} converted to ${item.floorPrice.toFixed(2)} TON!`, 'success');
}

function handleUpgrade() {
    const selectedItemId = upgradeElements.inventorySelect.value;
    if (!selectedItemId) {
        showTGNotification("Please select an item to upgrade.", 'error'); return;
    }

    const itemIndex = currentUser.inventory.findIndex(item => item.id === selectedItemId);
    if (itemIndex === -1) { // Item not found (might happen if selection/inventory mismatch)
         showTGNotification("Selected item not found in inventory.", 'error'); return;
    }
    const itemToUpgrade = currentUser.inventory[itemIndex];
    const currentChance = upgradeChances[selectedMultiplier] || 0; 

    upgradeElements.upgradeResult.textContent = "Attempting upgrade...";
    upgradeElements.doUpgradeButton.disabled = true;

    setTimeout(() => {
        const success = Math.random() * 100 < currentChance; 
        if (success) {
            itemToUpgrade.floorPrice = parseFloat((itemToUpgrade.floorPrice * selectedMultiplier).toFixed(2));
            upgradeElements.upgradeResult.textContent = `Success! ${itemToUpgrade.name} value increased to ${itemToUpgrade.floorPrice.toFixed(2)} TON.`;
            showTGNotification("Upgrade successful!", 'success');
        } else {
            const lostItemName = itemToUpgrade.name; // Store name before splicing
            currentUser.inventory.splice(itemIndex, 1); 
            upgradeElements.upgradeResult.textContent = `Failed! ${lostItemName} was destroyed. Sent to @Vasiliy939.`;
            showTGNotification("Upgrade failed! Item lost.", 'error');
            // console.log(`Item ${lostItemName} lost in upgrade, would be sent to Vasiliy939 (TG ID 5146625949)`);
        }
        renderInventory(); // Update inventory select and display
        upgradeElements.doUpgradeButton.disabled = false;
        upgradeElements.inventorySelect.value = ''; // Reset selection
        // Update chance display back to default if needed, or keep as is
        // const defaultChance = upgradeChances[1.5]; // Assuming 1.5x is default
        // upgradeElements.chanceDisplay.textContent = `${defaultChance}%`;
    }, 2000);
}

function handleDeposit() {
    const amountText = profileElements.depositAmountInput.value;
    if (!amountText.trim()) {
        showTGNotification("Please enter an amount to deposit.", 'warning');
        return;
    }
    const amount = parseFloat(amountText);
    if (isNaN(amount) || amount <= 0) {
        showTGNotification("Please enter a valid positive amount.", 'error');
        return;
    }
    currentUser.tonBalance += amount;
    updateBalances();
    showTGNotification(`${amount.toFixed(2)} TON successfully added to your balance! (Test)`, 'success');
    profileElements.depositAmountInput.value = ''; 
}


// --- Event Listeners ---
appNavButtons.forEach(button => {
    button.addEventListener('click', () => navigateToPage(button.dataset.page));
});

spinButton.addEventListener('click', spinRoulette);
closeRouletteButton.addEventListener('click', closeRouletteModal);

profileElements.confirmDepositButton.addEventListener('click', handleDeposit); 
profileElements.disconnectWalletButton.addEventListener('click', () => {
    currentUser.walletAddress = "Connect Wallet"; 
    renderHeader();
    renderProfile();
    showTGNotification("Wallet Disconnected (Demo).", 'info');
});

upgradeElements.multiplierButtons.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', (e) => {
        selectedMultiplier = parseFloat(e.target.dataset.multiplier);
        const chance = parseFloat(e.target.dataset.chance);
        upgradeElements.chanceDisplay.textContent = `${chance}%`; // Update chance display

        upgradeElements.multiplierButtons.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active-multiplier'); 
            if(!btn.classList.contains('button-secondary')) btn.classList.add('button-secondary');
        });
        e.target.classList.add('active-multiplier');
        if(e.target.classList.contains('button-secondary')) e.target.classList.remove('button-secondary');

    });
});
// Initialize chance display for default multiplier
const defaultMultiplierButton = upgradeElements.multiplierButtons.querySelector(`[data-multiplier="${selectedMultiplier}"]`);
if (defaultMultiplierButton) {
    defaultMultiplierButton.classList.add('active-multiplier');
    if(defaultMultiplierButton.classList.contains('button-secondary')) defaultMultiplierButton.classList.remove('button-secondary');
    upgradeElements.chanceDisplay.textContent = `${defaultMultiplierButton.dataset.chance}%`;
}


upgradeElements.doUpgradeButton.addEventListener('click', handleUpgrade);

inviteElements.copyRefLinkButton.addEventListener('click', () => {
    navigator.clipboard.writeText(inviteElements.referralLink.value)
        .then(() => showTGNotification("Referral Code copied!", 'success'))
        .catch(err => showTGNotification("Failed to copy code.", 'error'));
});
inviteElements.withdrawReferralButton.addEventListener('click', () => {
    if (currentUser.referralEarnings > 0) {
        currentUser.tonBalance += currentUser.referralEarnings;
        currentUser.referralEarnings = 0;
        updateBalances();
        renderInvitePage();
        showTGNotification("Referral Earnings claimed!", 'success');
    } else {
        showTGNotification("No earnings to claim.", 'info');
    }
});


// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    preloadImages(imageUrlsToPreload); // Start preloading

    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand(); 
        try { 
            const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-gradient-start').trim();
            Telegram.WebApp.setHeaderColor(bgColor);
            Telegram.WebApp.setBackgroundColor(bgColor);
        } catch (e) {
            // Silent fail
        }
    }

    renderHeader();
    renderCases();
    renderProfile(); 
    renderLeaderboard();
    renderInvitePage();
    navigateToPage('main-page'); 
});
</script>
</body>
</html>
