<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pusik Gifts - TON Universe</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
    <!-- TON Connect UI (зависит от SDK) -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <!-- Lottie-Web Player from CDN (optional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <style>
        /* --- MODERN & BEAUTIFUL CSS THEME --- */
        :root {
            --bg-primary: #0F0F1A; /* Deep space blue */
            --bg-secondary: #1A1A2E; /* Slightly lighter space blue */
            --bg-tertiary-alpha: rgba(26, 26, 46, 0.85); /* For blurred backgrounds */

            --surface-primary: #24243D; /* Card backgrounds, slightly purpleish */
            --surface-secondary: #30304D; /* Hover states, inputs */
            --surface-tertiary: #1D1D33; /* Borders, subtle dividers */

            --accent-primary: #7B61FF; /* Vibrant purple - main accent */
            --accent-primary-gradient-start: #8A2BE2; /* BlueViolet */
            --accent-primary-gradient-end: #4A00E0; /* Electric Purple */

            --accent-secondary: #00E0C6; /* Bright teal/cyan - secondary accent */
            --accent-secondary-gradient-start: #00E0C6;
            --accent-secondary-gradient-end: #00A2C6;


            --text-primary: #E0E0FF; /* Soft white/lavender for primary text */
            --text-secondary: #A0A0C0; /* Lighter purple/gray for secondary text */
            --text-placeholder: #6A6A8F; /* Muted placeholder text */
            --text-on-accent: #FFFFFF; /* White text on accent backgrounds */
            --text-value: var(--accent-secondary); /* For TON values, balances */

            --border-primary: var(--surface-tertiary);
            --border-secondary: rgba(123, 97, 255, 0.3); /* Accent border */
            --border-focus: var(--accent-primary);

            --success: #30D158;
            --warning: #FFAB00;
            --danger: #FF453A;

            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 15px;
            --line-height-base: 1.5;

            --border-radius-main: 16px;
            --border-radius-button: 12px;
            --border-radius-input: 10px;
            --border-radius-card: 20px; /* More rounded cards */

            --shadow-soft: 0px 8px 24px rgba(15, 15, 26, 0.2);
            --shadow-medium: 0px 12px 32px rgba(15, 15, 26, 0.25);
            --shadow-strong: 0px 4px 12px rgba(123, 97, 255, 0.2), 0px 16px 40px rgba(15, 15, 26, 0.3);

            --transition-fast: 0.15s ease-out;
            --transition-smooth: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(160deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-weight: 500;
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        #app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        /* Header - Modernized */
        #app-header {
            padding: 12px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--bg-tertiary-alpha);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--surface-tertiary);
            box-shadow: 0 4px 15px rgba(15, 15, 26, 0.1);
        }

        .app-logo-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #app-logo {
            width: 36px; /* Adjust size as needed */
            height: 36px;
            border-radius: 8px;
            object-fit: cover;
        }

        #app-header .app-title {
            font-size: 1.5em; /* Slightly larger */
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            flex-shrink: 0;
        }

        #app-header .wallet-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 1;
            min-width: 0;
        }
        #ton-connect-button { /* This will be styled by TON Connect UI, but we can provide a root */
             display: inline-block;
             flex-shrink: 0;
        }
        /* Style for TC button if it's just a placeholder */
        #ton-connect-button button {
            background: linear-gradient(45deg, var(--accent-primary-gradient-start), var(--accent-primary-gradient-end));
            color: var(--text-on-accent) !important; /* Important to override TC UI if needed */
            border: none;
            padding: 8px 14px;
            border-radius: var(--border-radius-button);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all var(--transition-smooth);
            box-shadow: var(--shadow-soft);
        }
        #ton-connect-button button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }


        #wallet-address-display, #balance {
            background-color: var(--surface-secondary);
            padding: 8px 12px;
            border-radius: var(--border-radius-button);
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid var(--surface-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px; /* Increased max width */
            display: none; /* Initially hidden */
            color: var(--text-secondary);
            transition: all var(--transition-smooth);
        }
         #wallet-address-display.connected, #balance.connected {
             display: flex; /* Use flex for icon alignment */
             align-items: center;
             gap: 6px;
         }
         #balance.connected { color: var(--text-value); }
         #ton-connect-button.connected { display: none; } /* Handled by TC UI */

        #app-header .ton-icon {
            width: 18px; height: 18px;
            /* Using a more modern TON SVG icon (example) */
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.28 16.39L12.03 12.14L7.78 16.39C7.47 16.7 6.97 16.7 6.66 16.39C6.35 16.08 6.35 15.58 6.66 15.27L11.41 10.52L10.03 9.14L6.08 13.09C5.77 13.4 5.27 13.4 4.96 13.09C4.65 12.78 4.65 12.28 4.96 11.97L9.81 7.12C10.21 6.72 10.84 6.72 11.24 7.12L12.61 8.5L16.56 4.55C16.87 4.24 17.37 4.24 17.68 4.55C17.99 4.86 17.99 5.36 17.68 5.67L13.17 10.18L17.25 14.26C17.65 14.66 17.57 15.3 17.17 15.7C16.95 15.92 16.66 16.02 16.37 16.02C16.14 16.02 15.91 15.94 15.72 15.75L12.03 12.06L9.83 14.26L11.42 15.85L16.27 11.01C16.68 10.61 17.31 10.61 17.71 11.01C18.11 11.41 18.11 12.04 17.71 12.44L12.58 17.57C12.27 17.88 11.77 17.88 11.46 17.57L7.78 13.89L6.66 15.27C6.35 15.58 6.35 16.08 6.66 16.39C6.81 16.54 7.01 16.62 7.21 16.62C7.41 16.62 7.61 16.54 7.76 16.39L11.44 12.71L12.03 13.3L16.28 9.05L17.39 10.16L12.54 15.01L16.28 16.39Z' fill='var(--accent-secondary)'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }


        /* Content Area */
        #app-content {
            flex-grow: 1;
            padding: 24px 18px; /* Increased padding */
            overflow-y: auto;
            padding-bottom: 80px; /* Space for nav bar */
        }
        .page { display: none; }
        .page.active {
            display: block;
            animation: pageFadeInSmooth 0.4s var(--transition-smooth);
        }
        @keyframes pageFadeInSmooth {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0px); }
        }

        /* Navigation Bar - Modernized */
        #app-nav {
            display: flex;
            justify-content: space-around;
            align-items: stretch; /* Stretch items for full height touch targets */
            background-color: var(--bg-tertiary-alpha);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid var(--surface-tertiary);
            padding: 0; /* Padding handled by buttons */
            position: sticky;
            bottom: 0;
            z-index: 1000;
            min-height: 65px; /* Increased height */
            box-shadow: 0 -5px 20px rgba(15, 15, 26, 0.15);
        }
        .nav-button {
            background: none; border: none;
            color: var(--text-secondary);
            display: flex; flex-direction: column; align-items: center; justify-content: center; /* Centering content */
            font-size: 11px;
            font-weight: 600; /* Slightly bolder */
            cursor: pointer;
            padding: 8px 5px; /* Adjusted padding */
            transition: all var(--transition-smooth);
            flex: 1; text-align: center;
            line-height: 1.3;
            position: relative; /* For active indicator */
        }
        .nav-button:hover { color: var(--text-primary); }
        .nav-button:active { transform: scale(0.96); }
        .nav-button.active {
            color: var(--accent-primary);
            font-weight: 700;
        }
        /* Active indicator line */
        .nav-button.active::before {
            content: '';
            position: absolute;
            bottom: 0; /* Changed from top to bottom */
            left: 50%;
            transform: translateX(-50%);
            width: 30px; /* Width of the indicator */
            height: 3px; /* Thickness */
            background-color: var(--accent-primary);
            border-radius: 3px;
            animation: navIndicatorGrow 0.3s var(--transition-smooth);
        }
        @keyframes navIndicatorGrow {
            from { width: 0; opacity: 0;}
            to { width: 30px; opacity: 1;}
        }

        .nav-button svg {
            width: 28px; height: 28px; /* Slightly larger icons */
            margin-bottom: 4px;
            fill: currentColor; /* SVG inherits color from parent */
             transition: all var(--transition-smooth);
        }
        .nav-button.active svg {
            fill: var(--accent-primary);
            transform: scale(1.1); /* Slight pop for active icon */
        }


        /* General UI Elements - Modernized */
        .button {
            background: linear-gradient(45deg, var(--accent-primary-gradient-start), var(--accent-primary-gradient-end));
            color: var(--text-on-accent);
            border: none; padding: 14px 24px; /* Generous padding */
            border-radius: var(--border-radius-button);
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-smooth);
            text-align: center;
            display: block;
            width: 100%;
            box-shadow: var(--shadow-soft);
            letter-spacing: 0.3px;
        }
        .button:hover {
            filter: brightness(1.15);
            transform: translateY(-2px); /* Subtle lift */
            box-shadow: var(--shadow-medium);
        }
        .button:active {
            transform: scale(0.97) translateY(0px);
            filter: brightness(0.9);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .button:disabled {
            background: var(--surface-secondary);
            color: var(--text-placeholder);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .button-secondary {
            background: var(--surface-primary);
            color: var(--text-secondary);
            border: 1px solid var(--surface-tertiary);
            box-shadow: none;
        }
        .button-secondary:hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
            border-color: var(--border-secondary);
             transform: translateY(-1px);
        }
         .button-secondary:active {
            background: var(--surface-tertiary);
            filter: brightness(0.95);
             transform: scale(0.98);
        }

        h2 {
            font-size: 2em; /* Larger headings */
            font-weight: 800; /* Bolder */
            color: var(--text-primary);
            padding-bottom: 12px; margin-bottom: 28px; /* More spacing */
            letter-spacing: -0.5px;
            /* border-bottom: 1px solid var(--surface-tertiary); */ /* Optional subtle underline */
        }
        h3 {
            font-size: 1.2em;
            font-weight: 700; /* Bolder */
            color: var(--text-secondary);
            margin-top: 24px;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.8px; /* Wider spacing */
        }
        .content-card {
            background-color: var(--surface-primary);
            padding: 20px 24px; /* Increased padding */
            border-radius: var(--border-radius-card); /* More rounded */
            margin-bottom: 24px; /* More spacing */
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--surface-tertiary);
            transition: transform var(--transition-smooth), box-shadow var(--transition-smooth);
        }
        .content-card:hover {
            /* transform: translateY(-2px); */ /* Optional hover lift */
            /* box-shadow: var(--shadow-medium); */
        }


        /* Main Page - Cases - Modernized */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(165px, 1fr)); /* Slightly wider min */
            gap: 20px; /* Increased gap */
        }
        .case-card {
            background: var(--case-grad-default, linear-gradient(145deg, var(--surface-primary), var(--surface-secondary)));
            border-radius: var(--border-radius-card);
            padding: 20px; /* Increased padding */
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-smooth);
            border: 1px solid var(--surface-tertiary);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-soft);
        }
        .case-card:hover {
            transform: translateY(-5px) scale(1.02); /* More pronounced hover */
            box-shadow: var(--shadow-strong); /* Stronger shadow on hover */
            border-color: var(--border-secondary);
        }
        .case-card .case-image-display {
            width: 90px; height: 90px; /* Larger image */
            margin: 0 auto 18px auto; /* More margin */
            background-color: rgba(255, 255, 255, 0.03); /* Very subtle bg */
            border-radius: var(--border-radius-button);
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex; align-items: center; justify-content: center; /* For placeholder */
        }
        .case-card .case-image-display img {
            display: block;
            width: 100%; height: 100%;
            object-fit: cover; /* Cover for background cases */
        }
        .case-card .case-image-display img.overlay-image { /* For overlay prize on background cases */
             position: absolute;
             width: 75%; height: 75%;
             top: 50%; left: 50%;
             transform: translate(-50%, -50%);
             object-fit: contain; /* Contain for overlay */
             pointer-events: none;
             filter: drop-shadow(0 3px 5px rgba(0,0,0,0.4));
         }
        .case-card .case-name {
            font-weight: 700; /* Bolder name */
            font-size: 1.05em; margin-bottom: 8px;
            color: var(--text-primary);
            min-height: 2.6em; /* Ensure consistent height */
            display: flex; align-items: center; justify-content: center;
            line-height: 1.3;
        }
        .case-card .case-price {
            font-size: 0.95em; font-weight: 600; /* Bolder price */
            color: var(--text-value); /* Use accent for price */
        }

        /* Modals - Base - Modernized */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(15, 15, 26, 0.7); /* Darker backdrop */
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            overflow-y: auto;
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            padding: 20px; /* Padding for small screens */
        }
        .modal.active {
            display: flex;
            animation: modalFadeInSmooth 0.3s var(--transition-smooth);
        }
        @keyframes modalFadeInSmooth {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0px); }
        }
        .modal-content {
            background-color: var(--surface-primary);
            padding: 28px; /* Generous padding */
            border-radius: var(--border-radius-card);
            width: 100%; max-width: 420px; /* Slightly wider */
            text-align: center;
            box-shadow: var(--shadow-strong);
            border: 1px solid var(--surface-tertiary);
            display: flex; flex-direction: column;
            margin: auto;
            max-height: 90vh; /* Prevent overflow on short screens */
        }
         .modal-content h3 { /* Modal title */
            margin-top: 0; margin-bottom: 20px;
            font-size: 1.6em; font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.3px;
             flex-shrink: 0;
        }
        .modal-actions { margin-top:20px; margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px;  flex-shrink: 0; }
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
            -webkit-overflow-scrolling: touch;
            margin-top: 10px;
            padding: 0 5px; /* Small padding for scrollbar */
        }
        .modal-body p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .modal-body strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Input fields - Modernized */
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 14px 16px; /* Increased padding */
            margin-bottom: 16px; /* Increased margin */
            border-radius: var(--border-radius-input);
            background-color: var(--surface-secondary);
            color: var(--text-primary); border: 1px solid var(--surface-tertiary);
            font-size: 1em; font-weight: 500; box-sizing: border-box;
            transition: all var(--transition-smooth);
        }
        input[type="text"]::placeholder, input[type="number"]::placeholder { color: var(--text-placeholder); }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none; border-color: var(--border-focus);
            background-color: var(--surface-primary); /* Darken on focus */
            box-shadow: 0 0 0 3px rgba(123, 97, 255, 0.2); /* Accent glow */
        }
        select {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23A0A0C0' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px; /* Space for arrow */
        }

        /* Loader - Modernized */
        .loader {
            border: 4px solid var(--surface-secondary);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 36px; height: 36px; /* Slightly smaller */
            animation: spin 0.8s linear infinite;
            margin: 24px auto; /* More margin */
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Roulette Modal - specific enhancements */
        #roulette-wheel {
            height: 270px;
            border: 1px solid var(--surface-tertiary);
            border-radius: var(--border-radius-button);
            overflow: hidden; position: relative;
            background-color: var(--bg-secondary); /* Darker wheel bg */
            margin: 20px 0;
            box-shadow: inset 0 0 15px rgba(15,15,26,0.3);
        }
        #roulette-wheel::before { /* Center line indicator */
            content: '';
            position: absolute;
            left: 10px; right: 10px; top: 50%;
            height: 3px;
            background-color: var(--accent-primary);
            opacity: 0.9;
            transform: translateY(-50%);
            z-index: 2; pointer-events: none;
            border-radius: 3px;
        }
        .roulette-item {
            height: 90px;
            /* ... other styles ... */
            border-bottom: 1px solid var(--surface-tertiary);
            background-color: var(--surface-primary); /* Item background */
        }
         .roulette-item.is-winning img {
             filter: drop-shadow(0 0 8px var(--accent-primary)) brightness(1.1);
             transform: scale(1.05);
        }
        #possible-prizes-display {
            /* ... existing grid styles ... */
            gap: 12px; /* Slightly more gap */
        }
        .prize-card {
            background-color: var(--surface-secondary);
            border: 1px solid var(--surface-tertiary);
            /* ... other styles ... */
            transition: all var(--transition-fast);
        }
        .prize-card:hover {
            transform: scale(1.03);
            border-color: var(--border-secondary);
        }
        .prize-card-probability {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            /* ... other styles ... */
        }
        #prize-display { /* Won prize message */
            margin-top: 20px; font-size: 1.3em; font-weight: 700;
            color: var(--success);
            /* ... other styles ... */
        }


        /* Profile Page - Modernized */
         .profile-header { text-align: center; margin-bottom: 30px; padding-top: 15px;}
        .profile-avatar-placeholder {
            width: 90px; height: 90px; border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-primary-gradient-start), var(--accent-primary-gradient-end));
            display: flex; align-items: center; justify-content: center;
            font-size: 3em; font-weight: 700; color: var(--text-on-accent);
            margin: 0 auto 16px auto;
            border: 3px solid var(--surface-primary); /* Inner border for depth */
            box-shadow: 0 0 0 4px var(--accent-primary), var(--shadow-medium); /* Outer glow and shadow */
        }
        .profile-info .username { font-size: 1.6em; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.3px;}
        .profile-info .userid { font-size: 0.95em; color: var(--text-secondary); }
        #profile-balance-display {
            font-size:1.8em; font-weight:700; margin-bottom:12px;
            color: var(--text-value);
        }
        #profile-balance-display .ton-icon {
            width: 22px; height: 22px; vertical-align: -3px;
        }

        /* Inventory - Modernized */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Wider items */
            gap: 16px;
        }
        .inventory-item {
            background-color: var(--surface-secondary);
            border-radius: var(--border-radius-button);
            padding: 12px;
            text-align: center;
            display: flex; flex-direction: column; justify-content: space-between;
            border: 1px solid var(--surface-tertiary);
            transition: all var(--transition-smooth);
        }
        .inventory-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
            border-color: var(--border-secondary);
        }
         .inventory-item .item-image-display {
             width: 70px; height: 70px; /* Larger item images */
             margin: 0 auto 10px auto;
             background-color: var(--surface-primary); /* Slightly different bg */
             border-radius: 8px;
             /* ... other styles ... */
         }
        .inventory-item-name { font-size: 0.9em; font-weight: 600; margin-bottom: 5px; line-height: 1.3; color: var(--text-primary); }
        .inventory-item-value { font-size: 0.8em; color: var(--text-value); font-weight: 600; margin-bottom: 10px;}
        .inventory-item-actions .button {
            font-size: 0.8em; padding: 6px 10px;
        }
        #sell-all-button {
            margin-top: 20px;
            background: var(--danger);
            box-shadow: 0 3px 8px rgba(255, 69, 58, 0.3);
        }
         #sell-all-button:hover { background: var(--danger); filter: brightness(1.1); }


        /* Upgrade Page - Modernized */
         #upgrade-chance-display {
            font-size: 3em; font-weight: 800; color: var(--text-primary);
            text-align:center; margin: 24px auto; padding: 20px;
            background-color: var(--surface-secondary);
            border-radius: 50%; width:120px; height:120px; line-height: 80px;
            border: 4px solid var(--accent-primary);
            box-shadow: 0 0 20px rgba(123, 97, 255, 0.3), var(--shadow-soft);
        }
        .multiplier-buttons { display: flex; justify-content: center; gap: 10px; margin: 24px 0; flex-wrap: wrap; }
        .multiplier-buttons button {
            width: auto; flex-grow: 1; padding: 12px; font-size: 0.95em;
            transition: all var(--transition-smooth);
        }
        .multiplier-buttons button.active-multiplier {
            background: var(--accent-primary);
            color: var(--text-on-accent);
            box-shadow: var(--shadow-medium);
            transform: scale(1.05);
        }
        #upgrade-result {
            margin-top: 20px; font-weight: 600; text-align:center; font-size: 1.1em;
        }

        /* --- Deposit Modal Styling --- */
        #deposit-instructions-modal .modal-body p {
            margin-bottom: 12px;
        }
        #deposit-instructions-modal strong#deposit-modal-amount-display {
            color: var(--accent-secondary); /* Highlight amount */
            font-weight: 700;
        }
        #ton-payment-link-button {
            font-size: 1.1em;
            padding: 15px 25px; /* Make it prominent */
        }
        #deposit-instructions-modal .button-secondary {
            font-size: 0.9em;
            padding: 10px 15px;
        }
        /* Styling for manual fallback section */
        #deposit-instructions-modal div[style*="text-align:left"] {
             background-color: var(--surface-secondary) !important; /* Override inline if necessary */
             border: 1px solid var(--surface-tertiary);
             padding: 15px !important;
             border-radius: var(--border-radius-input) !important;
             font-size: 0.85em !important;
             line-height: 1.6;
        }
        #deposit-instructions-modal div[style*="text-align:left"] span {
            word-break: break-all;
            display: inline-block; /* Helps with word break */
            margin-left: 5px;
            color: var(--text-primary); /* Make actual values more prominent */
        }
        #deposit-expiry-info, #deposit-status-message {
            min-height: 1.5em; /* Prevent layout shifts */
        }


        /* Responsive Adjustments */
        @media (max-width: 360px) {
            h2 { font-size: 1.8em; }
            .cases-grid { grid-template-columns: 1fr; } /* Single column on very small screens */
            #app-header .app-title { font-size: 1.3em; }
            #app-logo { width: 30px; height: 30px;}
            .nav-button svg { width: 24px; height: 24px; }
            #app-nav { min-height: 60px; }
        }

    </style>
</head>
<body>
     <div id="app-container">
         <header id="app-header">
            <div class="app-logo-title">
                <img src="https://i.ibb.co/N6dt5Pc9/Background-Eraser-20250423-210102862.png" alt="Pusik Gifts Logo" id="app-logo">
                <div class="app-title">Pusik Gifts</div>
            </div>
            <div class="wallet-info">
                <div id="wallet-address-display">Connected: ...</div>
                <div id="balance">
                    <span id="ton-balance">0.00</span> <span class="ton-icon"></span>
                </div>
                <div id="ton-connect-button"></div>
            </div>
        </header>

        <main id="app-content">
            <div id="main-page" class="page active">
                <h2>Cases</h2>
                <div id="cases-grid" class="cases-grid">
                    <!-- Cases will be dynamically inserted here -->
                </div>
            </div>

             <div id="upgrade-page" class="page">
                <h2>Upgrade Item</h2>
                <div class="content-card">
                    <p style="text-align:center; margin-bottom:15px;">Select an item from your collection:</p>
                    <select id="upgrade-inventory-select">
                        <option value="">-- Choose Item --</option>
                    </select>
                    <div id="upgrade-chance-display">50%</div>
                     <p style="text-align:center; margin-bottom:10px;">Multiplier:</p>
                    <div id="multiplier-buttons" class="multiplier-buttons">
                        <button class="button button-secondary" data-multiplier="1.5" data-chance="50">x1.5</button>
                        <button class="button button-secondary" data-multiplier="2" data-chance="35">x2</button>
                        <button class="button button-secondary" data-multiplier="3" data-chance="25">x3</button>
                        <button class="button button-secondary" data-multiplier="5" data-chance="15">x5</button>
                        <button class="button button-secondary" data-multiplier="10" data-chance="8">x10</button>
                        <button class="button button-secondary" data-multiplier="20" data-chance="3">x20</button>
                    </div>
                    <button id="do-upgrade-button" class="button">Attempt Upgrade</button>
                    <p id="upgrade-result" style="margin-top: 15px; font-weight: 500; text-align:center;"></p>
                </div>
            </div>

            <div id="invite-page" class="page">
                <h2>Referrals</h2>
                 <div class="content-card">
                    <p style="font-size: 1em; margin-bottom: 15px; text-align:center;">Invite friends and earn <strong>10%</strong> of their deposits!</p>
                    <input type="text" id="referral-link" value="https://t.me/YourAppBot?start=ref_USER123" readonly>
                    <button id="copy-ref-link-button" class="button" style="margin-bottom: 20px;">Copy Referral Code</button>

                    <div class="stats-box" style="margin-bottom: 20px; display:flex; gap:15px;">
                        <div class="stat-item" style="flex:1; background:var(--surface-secondary); padding:15px; border-radius:var(--border-radius-button); text-align:center;">
                            <div id="referral-balance" class="value" style="font-size:1.5em; font-weight:700; color:var(--text-value);">0.00 <span class="ton-icon"></span></div>
                            <div class="label" style="font-size:0.85em; color:var(--text-secondary); margin-top:5px;">Referral Earnings</div>
                        </div>
                        <div class="stat-item" style="flex:1; background:var(--surface-secondary); padding:15px; border-radius:var(--border-radius-button); text-align:center;">
                            <div id="invited-count" class="value" style="font-size:1.5em; font-weight:700; color:var(--text-value);">0</div>
                            <div class="label" style="font-size:0.85em; color:var(--text-secondary); margin-top:5px;">Friends Invited</div>
                        </div>
                    </div>
                    <button id="withdraw-referral-button" class="button button-secondary">Withdraw Earnings</button>
                </div>
                <div class="content-card">
                    <h3>Invited Friends (Demo)</h3>
                    <div class="invited-users-list" style="color:var(--text-secondary);">
                        <div style="padding: 8px 0; border-bottom: 1px solid var(--surface-tertiary);">User_Alpha7 - Profit: 1.5 TON</div>
                        <div style="padding: 8px 0;">User_BetaMax - Profit: 0.5 TON</div>
                    </div>
                </div>
            </div>


            <div id="leaderboard-page" class="page">
                <h2>Leaderboard</h2>
                <div id="leaderboard-list" class="leaderboard-list content-card" style="padding-top:0; padding-bottom:0;">
                    <!-- Leaderboard entries -->
                </div>
            </div>

            <div id="profile-page" class="page">
                <div class="profile-header">
                    <div id="profile-avatar" class="profile-avatar-placeholder">P</div>
                    <div class="profile-info">
                        <div id="profile-username" class="username">User</div>
                        <div id="profile-userid" class="userid">#...</div>
                    </div>
                </div>

                <div class="content-card">
                    <h3>Balance</h3>
                    <div id="profile-balance-display" style="font-size:1.6em; font-weight:600; margin-bottom:10px;">0.00 <span class="ton-icon"></span></div>
                    <input type="number" id="deposit-amount-input" placeholder="Amount in TON (e.g., 1.5)" style="margin-bottom: 10px;">
                    <button id="initiate-deposit-button" class="button">Deposit TON</button>
                </div>

                <div class="content-card">
                     <h3>Wallet</h3>
                    <div id="profile-wallet-address" style="color:var(--text-secondary); margin-bottom:10px; word-break:break-all;">Not Connected</div>
                    <button id="disconnect-wallet-button" class="button button-secondary" style="display: none;">Disconnect Wallet</button>
                </div>

                <div class="content-card">
                    <h3>My Collection (<span id="inventory-count">0</span>)</h3>
                    <div id="inventory-grid" class="inventory-grid">
                        <p id="empty-inventory-message" style="grid-column: 1 / -1; text-align: center; color: var(--text-placeholder); padding:15px 0;">Your collection is empty.</p>
                        <!-- Inventory items will be here -->
                    </div>
                    <button id="sell-all-button" class="button" style="margin-top: 15px; display: none;">Sell All Items for <span id="sell-all-value">0.00</span> TON</button>
                </div>
            </div>
        </main>

        <nav id="app-nav">
             <button class="nav-button active" data-page="main-page">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                Cases
            </button>
            <button class="nav-button" data-page="upgrade-page">
                 <svg viewBox="0 0 24 24"><path d="M9.48 5.55L6.91 8.12L5.5 6.71L9.48 2.73L13.47 6.71L12.06 8.12L9.48 5.55M9.48 5.55V13.75C9.48 14.15 9.15 14.48 8.75 14.48C8.35 14.48 8.02 14.15 8.02 13.75V5.55L5.45 8.12L4.04 6.71L8.02 2.73L12.01 6.71L10.6 8.12L8.02 5.55M15.25 10.25C14.85 10.25 14.52 10.58 14.52 10.98V19.18L11.95 16.61L10.54 18L14.52 21.99L18.5 18L17.09 16.61L14.52 19.18V10.98C14.52 10.58 14.19 10.25 13.79 10.25H15.25Z"/></svg>
                Upgrade
            </button>
            <button class="nav-button" data-page="invite-page">
                 <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                Referrals
            </button>
            <button class="nav-button" data-page="leaderboard-page">
                <svg viewBox="0 0 24 24"><path d="M16,1H4C2.89,1 2,1.89 2,3V17H4V3H16V1M16.5,5H7.5C6.67,5 6,5.67 6,6.5V22.5L12,19.5L18,22.5V6.5C18,5.67 17.33,5 16.5,5M14,11H10V9H14V11M14,15H10V13H14V15Z" /></svg>
                Leaders
            </button>
            <button class="nav-button" data-page="profile-page">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                Profile
            </button>
        </nav>
    </div>

    <!-- Roulette Modal -->
    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <h3 id="roulette-case-name">Opening Case...</h3>
            <div id="roulette-wheel-container">
                <div id="roulette-wheel">
                    <div id="roulette-spinner"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="spin-button" class="button">Spin</button>
                <button id="close-roulette-button" class="button button-secondary">Close</button>
            </div>
            <div id="prize-display" class="hidden">
                You got: <span id="won-prize-name"></span>!
            </div>
             <hr style="border: none; border-top: 1px solid var(--surface-tertiary); margin: 20px 0;">
             <h4 style="font-size: 1em; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Possible Prizes:</h4>
            <div id="possible-prizes-display"></div>
        </div>
    </div>

     <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <h3>Withdraw Gift</h3>
            <div class="modal-body">
                <div id="withdraw-step-1" class="modal-step active">
                    <p>To withdraw your gift via Tonnel Market, you first need to open their Mini App once to register.</p>
                    <a href="https://t.me/tonnel_network_bot/gifts?startapp=ref_5146625949" target="_blank" class="button" style="margin-bottom: 10px;">Open Tonnel Market</a>
                    <button id="withdraw-step1-next" class="button button-secondary">I've opened it</button>
                </div>
                <div id="withdraw-step-2" class="modal-step">
                    <p>Great! Now, please send <strong>any message</strong> to the <a href="tg://resolve?domain=giftrelayer" style="color: var(--accent-primary);">@giftrelayer</a> bot in Telegram. This allows the system to send the gift to you.</p>
                    <button id="withdraw-step2-next" class="button button-secondary">I've sent the message</button>
                     <button id="withdraw-step2-back" class="button button-secondary" style="margin-top: 10px;">Back</button>
                </div>
                <div id="withdraw-step-3" class="modal-step">
                     <p>Initiating withdrawal via Tonnel Network...</p>
                    <div class="loader"></div>
                    <p id="withdraw-status-message" style="font-size: 0.9em; color: var(--text-secondary);"></p>
                    <button id="withdraw-step3-close" class="button button-secondary" style="margin-top: 15px;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Instructions Modal -->
    <div id="deposit-instructions-modal" class="modal">
        <div class="modal-content">
            <h3>Complete Your TON Deposit</h3>
            <div class="modal-body" style="text-align: center;">
                <p>Click the button below to open your TON wallet and complete the payment for
                   <strong id="deposit-modal-amount-display" style="color:var(--accent-secondary);"></strong> TON.
                </p>
                <a href="#" id="ton-payment-link-button" target="_blank" class="button" style="margin-top: 20px; margin-bottom: 20px; text-decoration: none; font-size: 1.1em; padding: 15px 25px;">
                    Pay with TON Wallet
                </a>
                <p style="font-size:0.9em; color:var(--text-secondary);">If the button doesn't work, you can manually send:</p>
                <div style="font-size:0.85em; color:var(--text-secondary); text-align:left; margin-top:10px; background-color:var(--surface-secondary); padding:15px; border-radius:var(--border-radius-input); border:1px solid var(--surface-tertiary); line-height:1.6;">
                    To: <span id="manual-deposit-address" style="word-break: break-all; color: var(--text-primary); margin-left:5px;"></span><br>
                    Amount: <span id="manual-deposit-amount" style="color: var(--text-primary); margin-left:5px;"></span> TON<br>
                    Comment: <span id="manual-deposit-comment" style="color: var(--text-primary); margin-left:5px;"></span>
                </div>
                <p id="deposit-expiry-info" style="font-size:0.9em; color:var(--text-secondary); margin-top:20px; margin-bottom:15px; min-height: 1.5em;"></p>
                <p id="deposit-status-message" style="font-weight: 600; text-align:center; margin-bottom:15px; min-height: 1.5em;"></p>
                <div id="deposit-loader" class="loader" style="display:none; margin: 10px auto;"></div>
                <button id="confirm-payment-sent-button" class="button button-secondary" style="margin-top: 10px; font-size:0.9em; padding:10px 15px;">I Have Sent The Funds / Check Status</button>
                <button id="cancel-deposit-button" class="button button-secondary" style="margin-top: 10px; font-size:0.9em; padding:10px 15px;">Close</button>
            </div>
        </div>
    </div>

<script>
// --- Constants and Global State ---
const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/GiftImages/';
const CASE_BG_IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/bgs/';
const API_BASE_URL = 'https://case-v48j.onrender.com';

const currentUser = {
    id: null, username: null, first_name: 'User', last_name: null,
    walletAddress: null, walletAddressRaw: null, tonBalance: 0.00, starBalance: 0,
    inventory: [], referralCode: null, referralEarningsPending: 0, total_won_ton: 0,
};

let currentOpenCase = null;
let selectedMultiplier = 1.5;
let itemToWithdraw = null;

const upgradeChances = { 1.5: 50, 2: 35, 3: 25, 5: 15, 10: 8, 20: 3 };

function generateImageFilename(name) {
    if (!name) return 'placeholder.png';
    // Specific overrides first
    if (name === "Durov's Cap") return "Durov's-Cap.png";
    if (name === "Kissed Frog Happy Pepe") return "Kissed-Frog-Happy-Pepe.png"; // Corrected target
    if (name === "Vintage Cigar") return "Vintage-CIgar.png"; // Note: "CIgar" not "Cigar" if that's the actual filename

    // Handle background case names that might be passed directly
    const nameCleanedForBg = name.replace(/-/g, '_');
    if (['Amber', 'Midnight_Blue', 'Onyx_Black', 'Black'].includes(nameCleanedForBg)) {
        return nameCleanedForBg + '.png';
    }
    // General case: replace spaces, remove apostrophes etc.
    return name.replace(/\s+/g, '-').replace(/&/g, 'and').replace(/'/g, "") + '.png';
}


// --- casesData (Placeholder - to be filled) ---
const casesData = [
    { 
        id: 'lolpop', name: 'Lol Pop Stash', imageFilename: generateImageFilename('Lol Pop'), priceTON: 0.5,
        prizes: [
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.01 },
            { name: 'Party Sparkler', imageFilename: generateImageFilename('Party Sparkler'), floorPrice: 1, probability: 0.10 },
            { name: 'B-Day Candle', imageFilename: generateImageFilename('B-Day Candle'), floorPrice: 0.7, probability: 0.10 },
            { name: 'Homemade Cake', imageFilename: generateImageFilename('Homemade Cake'), floorPrice: 1, probability: 0.09 },
            { name: 'Lol Pop', imageFilename: generateImageFilename('Lol Pop'), floorPrice: 0.7, probability: 0.20 },
            { name: 'Hynpo Lollipop', imageFilename: generateImageFilename('Hynpo Lollipop'), floorPrice: 0.7, probability: 0.20 },
            { name: 'Desk Calendar', imageFilename: generateImageFilename('Desk Calendar'), floorPrice: 0.7, probability: 0.10 },
            { name: 'Cookie Heart', imageFilename: generateImageFilename('Cookie Heart'), floorPrice: 0.9, probability: 0.10 },
            { name: 'Jack-in-the-box', imageFilename: generateImageFilename('Jack-in-the-box'), floorPrice: 1, probability: 0.08 },
            { name: 'Skull Flower', imageFilename: generateImageFilename('Skull Flower'), floorPrice: 1.7, probability: 0.02 },
        ]
    },
    { 
        id: 'recordplayer', name: 'Record Player Vault', imageFilename: generateImageFilename('Record Player'), priceTON: 3,
        prizes: [
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.50 },
            { name: 'Lol Pop', imageFilename: generateImageFilename('Lol Pop'), floorPrice: 0.7, probability: 0.08 },
            { name: 'Hynpo Lollipop', imageFilename: generateImageFilename('Hynpo Lollipop'), floorPrice: 0.7, probability: 0.08 },
            { name: 'Party Sparkler', imageFilename: generateImageFilename('Party Sparkler'), floorPrice: 1, probability: 0.08 },
            { name: 'Skull Flower', imageFilename: generateImageFilename('Skull Flower'), floorPrice: 1.7, probability: 0.08 },
            { name: 'Jelly Bunny', imageFilename: generateImageFilename('Jelly Bunny'), floorPrice: 1.8, probability: 0.08 },
            { name: 'Tama Gadget', imageFilename: generateImageFilename('Tama Gadget'), floorPrice: 2, probability: 0.05 },
            { name: 'Snow Globe', imageFilename: generateImageFilename('Snow Globe'), floorPrice: 2, probability: 0.05 },
        ]
    },
    { 
        id: 'swisswatch', name: 'Swiss Watch Box', imageFilename: generateImageFilename('Swiss Watch'), priceTON: 5,
        prizes: [
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.20 },
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.10 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.15 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.15 },
            { name: 'Voodoo Doll', imageFilename: generateImageFilename('Voodoo Doll'), floorPrice: 4.2, probability: 0.10 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.10 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.05 },
        ]
    },
    { 
        id: 'perfumebottle', name: 'Perfume Chest', imageFilename: generateImageFilename('Perfume Bottle'), priceTON: 10,
        prizes: [
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.10 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.15 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.20 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.15 },
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.10 },
            { name: 'Kissed Frog', imageFilename: generateImageFilename('Kissed Frog'), floorPrice: 9, probability: 0.10 },
            { name: 'Loot Bag', imageFilename: generateImageFilename('Loot Bag'), floorPrice: 12, probability: 0.05 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.10 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.05 },
        ]
    },
    { 
        id: 'vintagecigar', name: 'Vintage Cigar Safe', imageFilename: generateImageFilename('Vintage Cigar'), priceTON: 20,
        prizes: [
            { name: 'Vintage Cigar', imageFilename: generateImageFilename('Vintage Cigar'), floorPrice: 13, probability: 0.10 },
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.15 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.20 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.15 },
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.15 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.10 },
            { name: 'Mini Oscar', imageFilename: generateImageFilename('Mini Oscar'), floorPrice: 18, probability: 0.08 },
            { name: 'Scared Cat', imageFilename: generateImageFilename('Scared Cat'), floorPrice: 17, probability: 0.07 },
        ]
    },
    { 
        id: 'astralshard', name: 'Astral Shard Relic', imageFilename: generateImageFilename('Astral Shard'), priceTON: 50,
        prizes: [
            { name: 'Astral Shard', imageFilename: generateImageFilename('Astral Shard'), floorPrice: 60, probability: 0.10 },
            { name: 'Vintage Cigar', imageFilename: generateImageFilename('Vintage Cigar'), floorPrice: 13, probability: 0.15 },
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.15 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.10 },
            { name: 'Precious Peach', imageFilename: generateImageFilename('Precious Peach'), floorPrice: 60, probability: 0.10 },
            { name: 'Mini Oscar', imageFilename: generateImageFilename('Mini Oscar'), floorPrice: 18, probability: 0.15 },
            { name: 'Scared Cat', imageFilename: generateImageFilename('Scared Cat'), floorPrice: 17, probability: 0.10 },
            { name: 'Loot Bag', imageFilename: generateImageFilename('Loot Bag'), floorPrice: 12, probability: 0.05 },
        ]
    },
    { 
        id: 'plushpepe', name: 'Plush Pepe Hoard', imageFilename: generateImageFilename('Plush Pepe'), priceTON: 100,
        prizes: [
            { name: 'Plush Pepe', imageFilename: generateImageFilename('Plush Pepe'), floorPrice: 560, probability: 0.10 },
             // Swapped probabilities for Astral Shard and Durov's Cap
            { name: 'Durov\'s Cap', imageFilename: generateImageFilename('Durov\'s Cap'), floorPrice: 150, probability: 0.40 }, 
            { name: 'Astral Shard', imageFilename: generateImageFilename('Astral Shard'), floorPrice: 60, probability: 0.50 },
        ]
    },
    { 
        id: 'happypepe', name: 'Happy Pepe Treasure', imageFilename: generateImageFilename('Happy Pepe Kissed Frog'), priceTON: 600,
        prizes: [
            { name: 'Kissed Frog Happy Pepe', imageFilename: generateImageFilename('Happy Pepe Kissed Frog'), floorPrice: 660, probability: 0.3636 },
            { name: 'Plush Pepe', imageFilename: generateImageFilename('Plush Pepe'), floorPrice: 560, probability: 0.6364 },
        ]
    },
    { 
        id: 'amber', name: 'Amber Nebula Case', 
        isBackgroundCase: true, bgImageFilename: 'Amber.png', overlayPrizeName: 'Swiss Watch', 
        priceTON: 3, 
        prizes: [
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.01 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.03 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.10 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.15 },
            { name: 'Voodoo Doll', imageFilename: generateImageFilename('Voodoo Doll'), floorPrice: 4.2, probability: 0.15 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.15 },
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.08 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.08 },
            { name: 'Sakura Flower', imageFilename: generateImageFilename('Sakura Flower'), floorPrice: 2, probability: 0.08 },
            { name: 'Jelly Bunny', imageFilename: generateImageFilename('Jelly Bunny'), floorPrice: 1.8, probability: 0.06 },
            { name: 'Skull Flower', imageFilename: generateImageFilename('Skull Flower'), floorPrice: 1.7, probability: 0.06 },
        ]
    },
    { 
        id: 'midnightblue', name: 'Midnight Blue Comet', 
        isBackgroundCase: true, bgImageFilename: 'Midnight_Blue.png', overlayPrizeName: 'Precious Peach', 
        priceTON: 3, 
        prizes: [ 
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.01 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.03 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.06 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.10 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.15 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.15 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.15 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.08 },
            { name: 'Tama Gadget', imageFilename: generateImageFilename('Tama Gadget'), floorPrice: 2, probability: 0.08 },
            { name: 'Snow Globe', imageFilename: generateImageFilename('Snow Globe'), floorPrice: 2, probability: 0.08 },
            { name: 'Sleigh Bell', imageFilename: generateImageFilename('Sleigh Bell'), floorPrice: 2, probability: 0.06 },
            { name: 'Candy Cane', imageFilename: generateImageFilename('Candy Cane'), floorPrice: 0.9, probability: 0.05 },
        ]
    },
    { 
        id: 'onyxblack', name: 'Onyx Black Hole', 
        isBackgroundCase: true, bgImageFilename: 'Onyx_Black.png', overlayPrizeName: 'Perfume Bottle', 
        priceTON: 5, 
        prizes: [ 
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.01 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.03 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.05 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.10 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.15 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.15 },
            { name: 'Eternal Rose', imageFilename: generateImageFilename('Eternal Rose'), floorPrice: 5.5, probability: 0.15 },
            { name: 'Voodoo Doll', imageFilename: generateImageFilename('Voodoo Doll'), floorPrice: 4.2, probability: 0.10 },
            { name: 'Top Hat', imageFilename: generateImageFilename('Top Hat'), floorPrice: 3, probability: 0.08 },
            { name: 'Toy Bear', imageFilename: generateImageFilename('Toy Bear'), floorPrice: 5.2, probability: 0.08 },
            { name: 'Love Potion', imageFilename: generateImageFilename('Love Potion'), floorPrice: 2.7, probability: 0.05 },
            { name: 'Record Player', imageFilename: generateImageFilename('Record Player'), floorPrice: 2, probability: 0.05 },
        ]
    },
    { 
        id: 'black', name: 'BLACK Singularity', 
        isBackgroundCase: true, bgImageFilename: 'Black.png', overlayPrizeName: 'Neko Helmet', 
        priceTON: 15, 
        prizes: [ 
            { name: 'Perfume Bottle', imageFilename: generateImageFilename('Perfume Bottle'), floorPrice: 21, probability: 0.01 },
            { name: 'Mini Oscar', imageFilename: generateImageFilename('Mini Oscar'), floorPrice: 18, probability: 0.03 },
            { name: 'Scared Cat', imageFilename: generateImageFilename('Scared Cat'), floorPrice: 17, probability: 0.05 },
            { name: 'Vintage Cigar', imageFilename: generateImageFilename('Vintage Cigar'), floorPrice: 13, probability: 0.10 },
            { name: 'Loot Bag', imageFilename: generateImageFilename('Loot Bag'), floorPrice: 12, probability: 0.15 },
            { name: 'Sharp Tongue', imageFilename: generateImageFilename('Sharp Tongue'), floorPrice: 10, probability: 0.15 },
            { name: 'Genie Lamp', imageFilename: generateImageFilename('Genie Lamp'), floorPrice: 9.6, probability: 0.15 },
            { name: 'Swiss Watch', imageFilename: generateImageFilename('Swiss Watch'), floorPrice: 9, probability: 0.10 },
            { name: 'Neko Helmet', imageFilename: generateImageFilename('Neko Helmet'), floorPrice: 7.5, probability: 0.10 },
            { name: 'Kissed Frog', imageFilename: generateImageFilename('Kissed Frog'), floorPrice: 9, probability: 0.08 },
            { name: 'Electric Skull', imageFilename: generateImageFilename('Electric Skull'), floorPrice: 6.3, probability: 0.05 },
            { name: 'Diamond Ring', imageFilename: generateImageFilename('Diamond Ring'), floorPrice: 5.7, probability: 0.03 },
        ]
    },
];
// 🔴🔴🔴 END OF casesData PLACEHOLDER 🔴🔴🔴

// --- Image Preloader ---
const imageUrlsToPreload = [];
if (Array.isArray(casesData)) {
    casesData.forEach(caseItem => {
        if (caseItem.isBackgroundCase && caseItem.bgImageFilename) {
            imageUrlsToPreload.push(CASE_BG_IMAGE_BASE_URL + caseItem.bgImageFilename);
             if(caseItem.overlayPrizeName){ // Preload overlay for background cases
                 const overlayFilename = generateImageFilename(caseItem.overlayPrizeName);
                 if (overlayFilename && !imageUrlsToPreload.includes(IMAGE_BASE_URL + overlayFilename)) {
                     imageUrlsToPreload.push(IMAGE_BASE_URL + overlayFilename);
                }
             }
        } else if (caseItem.imageFilename) { // For regular cases
             imageUrlsToPreload.push(IMAGE_BASE_URL + caseItem.imageFilename);
        }

        if (caseItem.prizes) {
            caseItem.prizes.forEach(prize => {
                if (prize && prize.imageFilename && !imageUrlsToPreload.includes(IMAGE_BASE_URL + prize.imageFilename)) {
                     imageUrlsToPreload.push(IMAGE_BASE_URL + prize.imageFilename);
                }
            });
        }
    });
}
function preloadImages(urls) { urls.forEach(url => { const img = new Image(); img.src = url; }); }

// --- DOM Elements ---
const headerElements = {
    title: document.querySelector('#app-header .app-title'),
    walletInfo: document.querySelector('#app-header .wallet-info'),
    tonConnectButton: document.getElementById('ton-connect-button'),
    walletAddressDisplay: document.getElementById('wallet-address-display'),
    balanceDisplay: document.getElementById('balance'),
    tonBalanceSpan: document.getElementById('ton-balance'),
};
const appNavButtons = document.querySelectorAll('.nav-button');
const pages = document.querySelectorAll('.page');
const casesGrid = document.getElementById('cases-grid');
const rouletteModal = document.getElementById('roulette-modal');
const rouletteCaseName = document.getElementById('roulette-case-name');
const rouletteWheel = document.getElementById('roulette-wheel');
const rouletteSpinner = document.getElementById('roulette-spinner');
const prizeDisplay = document.getElementById('prize-display');
const wonPrizeName = document.getElementById('won-prize-name');
const spinButton = document.getElementById('spin-button');
const closeRouletteButton = document.getElementById('close-roulette-button');
const possiblePrizesDisplay = document.getElementById('possible-prizes-display');
const withdrawModal = document.getElementById('withdraw-modal');
const withdrawSteps = withdrawModal.querySelectorAll('.modal-step');
const withdrawStep1NextBtn = document.getElementById('withdraw-step1-next');
const withdrawStep2NextBtn = document.getElementById('withdraw-step2-next');
const withdrawStep2BackBtn = document.getElementById('withdraw-step2-back');
const withdrawStep3CloseBtn = document.getElementById('withdraw-step3-close');
const withdrawStatusMessage = document.getElementById('withdraw-status-message');
const profileElements = {
    avatar: document.getElementById('profile-avatar'),
    username: document.getElementById('profile-username'),
    userid: document.getElementById('profile-userid'),
    balanceDisplay: document.getElementById('profile-balance-display'),
    walletAddress: document.getElementById('profile-wallet-address'),
    inventoryGrid: document.getElementById('inventory-grid'),
    inventoryCount: document.getElementById('inventory-count'),
    emptyInventoryMessage: document.getElementById('empty-inventory-message'),
    disconnectWalletButton: document.getElementById('disconnect-wallet-button'),
    depositAmountInput: document.getElementById('deposit-amount-input'),
    initiateDepositButton: document.getElementById('initiate-deposit-button'),
    sellAllButton: document.getElementById('sell-all-button'),
    sellAllValueSpan: document.getElementById('sell-all-value')
};
const upgradeElements = {
    inventorySelect: document.getElementById('upgrade-inventory-select'),
    multiplierButtons: document.getElementById('multiplier-buttons'),
    doUpgradeButton: document.getElementById('do-upgrade-button'),
    upgradeResult: document.getElementById('upgrade-result'),
    chanceDisplay: document.getElementById('upgrade-chance-display')
};
const inviteElements = {
    referralLink: document.getElementById('referral-link'),
    copyRefLinkButton: document.getElementById('copy-ref-link-button'),
    referralBalance: document.getElementById('referral-balance'),
    invitedCount: document.getElementById('invited-count'),
    withdrawReferralButton: document.getElementById('withdraw-referral-button')
};
const leaderboardList = document.getElementById('leaderboard-list');

// --- Deposit Modal DOM Elements ---
const depositInstructionsModal = document.getElementById('deposit-instructions-modal');
const depositModalAmountDisplay = document.getElementById('deposit-modal-amount-display');
const tonPaymentLinkButton = document.getElementById('ton-payment-link-button');
const manualDepositAddress = document.getElementById('manual-deposit-address');
const manualDepositAmount = document.getElementById('manual-deposit-amount');
const manualDepositComment = document.getElementById('manual-deposit-comment');
const confirmPaymentSentButton = document.getElementById('confirm-payment-sent-button');
const cancelDepositButton = document.getElementById('cancel-deposit-button');
const depositExpiryInfo = document.getElementById('deposit-expiry-info');
const depositStatusMessageEl = document.getElementById('deposit-status-message');
const depositLoader = document.getElementById('deposit-loader');

let currentPendingDepositId = null;
let depositExpiryInterval = null;

// --- TON Connect ---
const manifestUrl = 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/tonconnect-manifest.json';
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: manifestUrl, buttonRootId: 'ton-connect-button' });

// --- API Helper ---
async function apiRequest(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json', };
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) {
        headers['X-Telegram-Init-Data'] = Telegram.WebApp.initData;
    } else { console.warn("Telegram.WebApp.initData not available for API request."); }
    const config = { method: method, headers: headers, };
    if (body && (method.toUpperCase() === 'POST' || method.toUpperCase() === 'PUT')) { config.body = JSON.stringify(body); }
    try {
        const response = await fetch(API_BASE_URL + endpoint, config);
        if (!response.ok) {
            let errorData; try { errorData = await response.json(); } catch (e) { errorData = { error: `HTTP error! status: ${response.status}, ${response.statusText}` }; }
            console.error(`API Error (${endpoint} - ${response.status}):`, errorData);
            showTGNotification(errorData.error || `Request failed: ${response.statusText}`, 'error');
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        if (response.status === 204) { return null; } return await response.json();
    } catch (error) {
        console.error(`Network or API request error (${endpoint}):`, error);
        if (!error.message.startsWith("HTTP error!")) { showTGNotification(`Network error: ${error.message}`, 'error');}
        throw error;
    }
}

// --- Utility Functions ---
function updateBalances() {
    if (headerElements.tonBalanceSpan) { headerElements.tonBalanceSpan.textContent = currentUser.tonBalance.toFixed(2); }
    if (profileElements.balanceDisplay) { profileElements.balanceDisplay.innerHTML = `${currentUser.tonBalance.toFixed(2)} <span class="ton-icon"></span>`; }
}
function navigateToPage(pageId) {
    pages.forEach(page => page.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) { targetPage.classList.add('active'); }
    appNavButtons.forEach(btn => { btn.classList.toggle('active', btn.dataset.page === pageId); });
    window.scrollTo(0, 0);
}
function showTGNotification(message, type = 'info') {
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.showAlert) { Telegram.WebApp.showAlert(message); } else { alert(message); }
    if (window.Telegram && Telegram.WebApp.HapticFeedback) {
        if (type === 'success') Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        else if (type === 'error') Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        else if (type === 'warning') Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
    }
}

// --- Rendering Functions ---
function renderHeader() { updateBalances(); }
function updateUIBasedOnWallet(wallet) {
    const connected = !!wallet;
    if (connected) {
        const address = wallet.account.address; currentUser.walletAddressRaw = address;
        const userFriendlyAddress = TonConnectSDK.toUserFriendlyAddress(address, wallet.account.chain === TonConnectSDK.CHAIN.TESTNET);
        currentUser.walletAddress = userFriendlyAddress;
        if (headerElements.walletAddressDisplay) {
            headerElements.walletAddressDisplay.textContent = userFriendlyAddress.substring(0, 5) + '...' + userFriendlyAddress.substring(userFriendlyAddress.length - 4);
            headerElements.walletAddressDisplay.classList.add('connected'); headerElements.walletAddressDisplay.style.display = 'flex';
        }
        if(headerElements.balanceDisplay) { headerElements.balanceDisplay.classList.add('connected'); headerElements.balanceDisplay.style.display = 'flex'; }
        // TON Connect UI handles its own button visibility
        if(profileElements.walletAddress) profileElements.walletAddress.textContent = userFriendlyAddress;
        if(profileElements.disconnectWalletButton) profileElements.disconnectWalletButton.style.display = 'block';
    } else {
        currentUser.walletAddress = null; currentUser.walletAddressRaw = null;
        if (headerElements.walletAddressDisplay) {
            headerElements.walletAddressDisplay.textContent = ''; headerElements.walletAddressDisplay.classList.remove('connected'); headerElements.walletAddressDisplay.style.display = 'none';
        }
        if(headerElements.balanceDisplay) { headerElements.balanceDisplay.classList.remove('connected'); headerElements.balanceDisplay.style.display = 'none'; }
        if(profileElements.walletAddress) profileElements.walletAddress.textContent = 'Not Connected';
        if(profileElements.disconnectWalletButton) profileElements.disconnectWalletButton.style.display = 'none';
    }
    updateBalances();
}

function renderCases() {
    casesGrid.innerHTML = '';
    if (!casesData || casesData.length === 0) { casesGrid.innerHTML = "<p style='text-align:center; color:var(--text-secondary);'>Loading cases or no cases available...</p>"; return; }
    casesData.forEach(caseItem => {
        const card = document.createElement('div'); card.className = 'case-card'; card.dataset.caseId = caseItem.id; card.onclick = () => openRouletteModal(caseItem);
        const imageContainer = document.createElement('div'); imageContainer.className = 'case-image-display';
        const img = document.createElement('img'); img.loading = 'lazy'; img.alt = caseItem.name;
        img.onerror = (e) => { e.target.style.display='none'; imageContainer.textContent = '🎁'; imageContainer.style.fontSize='3em'; };

        if (caseItem.isBackgroundCase && caseItem.bgImageFilename) {
            img.src = CASE_BG_IMAGE_BASE_URL + caseItem.bgImageFilename;
            img.style.objectFit = 'cover';
            imageContainer.appendChild(img);
             if(caseItem.overlayPrizeName){
                 const overlayImg = document.createElement('img');
                 const overlayFilename = generateImageFilename(caseItem.overlayPrizeName);
                 overlayImg.src = overlayFilename ? IMAGE_BASE_URL + overlayFilename : '';
                 overlayImg.alt = caseItem.overlayPrizeName; overlayImg.loading = 'lazy'; overlayImg.className = 'overlay-image';
                 overlayImg.onerror = (e) => { e.target.style.display = 'none'; };
                 imageContainer.appendChild(overlayImg);
             }
        } else if (caseItem.imageFilename) {
            img.src = IMAGE_BASE_URL + caseItem.imageFilename;
            img.style.objectFit = 'contain';
            imageContainer.appendChild(img);
        } else { imageContainer.textContent = '🎁'; imageContainer.style.fontSize='3em'; }

        const nameEl = document.createElement('div'); nameEl.className = 'case-name'; nameEl.textContent = caseItem.name;
        const priceEl = document.createElement('div'); priceEl.className = 'case-price';
        let priceText = '';
        if (caseItem.priceTON) priceText += `${caseItem.priceTON.toFixed(1)} TON `;
        if (caseItem.priceStars) priceText += (priceText ? '/ ' : '') + `${caseItem.priceStars} ✨`;
        priceEl.textContent = priceText || 'Free';
        card.appendChild(imageContainer); card.appendChild(nameEl); card.appendChild(priceEl); casesGrid.appendChild(card);
    });
}

function renderProfile() {
    const initial = currentUser.first_name ? currentUser.first_name.charAt(0).toUpperCase() : (currentUser.username ? currentUser.username.charAt(0).toUpperCase() : 'P');
    profileElements.avatar.textContent = initial;
    profileElements.username.textContent = (currentUser.first_name || currentUser.last_name) ? `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() : currentUser.username || 'User';
    profileElements.userid.textContent = currentUser.id ? `#${currentUser.id}` : '#...';
    profileElements.walletAddress.textContent = currentUser.walletAddress || 'Not Connected';
    profileElements.disconnectWalletButton.style.display = currentUser.walletAddress ? 'block' : 'none';
    renderInventory();
}
function renderInventory() {
    profileElements.inventoryGrid.innerHTML = ''; let totalValue = 0;
    if (currentUser.inventory.length === 0) {
        profileElements.emptyInventoryMessage.style.display = 'block'; profileElements.sellAllButton.style.display = 'none';
    } else {
        profileElements.emptyInventoryMessage.style.display = 'none';
        currentUser.inventory.forEach(item => {
            totalValue += item.currentValue || item.floorPrice;
            const itemDiv = document.createElement('div'); itemDiv.className = 'inventory-item';
            const imgContainer = document.createElement('div'); imgContainer.className = 'item-image-display';
            const img = document.createElement('img'); img.src = item.imageFilename ? IMAGE_BASE_URL + item.imageFilename : '';
            img.alt = item.name; img.loading = 'lazy'; img.onerror = (e) => { e.target.style.display='none'; imgContainer.textContent = '❓';}
            imgContainer.appendChild(img);
            itemDiv.innerHTML = `<div class="inventory-item-name" title="${item.name}">${item.name}</div>
                <div class="inventory-item-value">${(item.currentValue || item.floorPrice).toFixed(2)} TON</div>
                <div class="inventory-item-actions">
                     <button class="button button-secondary withdraw-button" onclick="startWithdrawalProcess('${item.id}')">Withdraw</button>
                    <button class="button button-secondary" onclick="convertToTon('${item.id}')">Convert</button>
                </div>`;
            itemDiv.insertBefore(imgContainer, itemDiv.firstChild); profileElements.inventoryGrid.appendChild(itemDiv);
        });
        profileElements.sellAllButton.style.display = 'block'; profileElements.sellAllValueSpan.textContent = totalValue.toFixed(2);
    }
    profileElements.inventoryCount.textContent = currentUser.inventory.length;
    populateUpgradeInventorySelect();
}
function populateUpgradeInventorySelect() {
    upgradeElements.inventorySelect.innerHTML = '<option value="">-- Choose Item --</option>';
    currentUser.inventory.forEach(item => {
        const option = document.createElement('option'); option.value = item.id;
        option.textContent = `${item.name} (${(item.currentValue || item.floorPrice).toFixed(2)} TON)`;
        upgradeElements.inventorySelect.appendChild(option);
    });
}
async function renderLeaderboard() {
    leaderboardList.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Loading leaders...</p>';
    try {
        const leaders = await apiRequest('/api/get_leaderboard'); leaderboardList.innerHTML = '';
        if (leaders && leaders.length > 0) {
            leaders.forEach(leader => {
                const entry = document.createElement('div'); entry.className = 'leader-entry'; if (leader.user_id === currentUser.id) entry.classList.add('current-user-entry');
                entry.innerHTML = `<div class="rank">#${leader.rank}</div>
                    <div class="avatar-placeholder">${leader.avatarChar}</div>
                    <div class="info"><div class="name">${leader.name}</div><div class="details">Total Won: ${(leader.income || 0).toFixed(2)} TON</div></div>
                    <div class="score">${(leader.income || 0).toFixed(1)} <span class="ton-icon"></span></div>`;
                leaderboardList.appendChild(entry);
            });
        } else { leaderboardList.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">No leaders yet.</p>'; }
    } catch (error) { leaderboardList.innerHTML = '<p style="text-align:center; color: var(--danger-color);">Could not load leaderboard.</p>'; }
}
function renderInvitePage() {
    const botUsername = (window.Telegram && Telegram.WebApp.initDataUnsafe?.bot?.username) ? Telegram.WebApp.initDataUnsafe.bot.username : 'YourAppBot';
    inviteElements.referralLink.value = currentUser.referralCode ? `https://t.me/${botUsername}?start=${currentUser.referralCode}` : 'Loading...';
    inviteElements.referralBalance.innerHTML = `${currentUser.referralEarningsPending.toFixed(2)} <span class="ton-icon"></span>`;
    inviteElements.invitedCount.textContent = '-';
}

// --- Roulette Logic ---
function openRouletteModal(caseItem) {
    currentOpenCase = caseItem; if (!currentOpenCase || !currentOpenCase.prizes) { showTGNotification("Error loading case data.", "error"); return; }
    rouletteCaseName.textContent = caseItem.name;
    spinButton.textContent = `Spin (${caseItem.priceTON ? caseItem.priceTON.toFixed(1) + ' TON' : ''} ${caseItem.priceStars && caseItem.priceTON ? '/' : ''} ${caseItem.priceStars ? caseItem.priceStars + ' ✨' : ''})`;
    spinButton.disabled = false; prizeDisplay.classList.add('hidden'); wonPrizeName.textContent = '';
    rouletteSpinner.innerHTML = ''; rouletteSpinner.style.transition = 'none'; rouletteSpinner.style.top = '0px';
    let spinnerItemsContent = [];
    for (let i = 0; i < 80; i++) { spinnerItemsContent.push(currentOpenCase.prizes[Math.floor(Math.random() * currentOpenCase.prizes.length)]); }
    spinnerItemsContent.forEach(prize => {
        if (!prize || !prize.imageFilename) return; const itemEl = document.createElement('div'); itemEl.className = 'roulette-item';
        const img = document.createElement('img'); img.src = IMAGE_BASE_URL + prize.imageFilename; img.alt = prize.name || 'Prize'; img.loading = 'lazy';
        img.onerror = (e) => { e.target.style.display='none'; itemEl.textContent = '❓'; itemEl.style.fontSize='2em'; }
        itemEl.appendChild(img); rouletteSpinner.appendChild(itemEl);
    });
    possiblePrizesDisplay.innerHTML = ''; const prizeMap = new Map();
    currentOpenCase.prizes.forEach(p => {
        if(!p || !p.name) return;
        if (prizeMap.has(p.name)) { prizeMap.set(p.name, { ...prizeMap.get(p.name), probability: prizeMap.get(p.name).probability + p.probability });
        } else { prizeMap.set(p.name, { ...p }); }
    });
    prizeMap.forEach((prizeData, name) => {
        if (!prizeData || !prizeData.imageFilename) return; const probability = prizeData.probability || 0;
        const prizeCard = document.createElement('div'); prizeCard.className = 'prize-card';
        const imgContainer = document.createElement('div'); imgContainer.className = 'prize-card-image-placeholder';
        const img = document.createElement('img'); img.src = IMAGE_BASE_URL + prizeData.imageFilename; img.alt = name; img.loading = 'lazy';
        img.onerror = (e) => { e.target.style.display='none'; imgContainer.textContent = '❓';}
        imgContainer.appendChild(img);
        prizeCard.innerHTML = `<span class="prize-card-probability">${(probability * 100).toFixed(probability < 0.01 ? 3 : (probability < 0.1 ? 2 : 1) )}%</span>
            <span class="prize-card-name">${name}</span>`;
        prizeCard.insertBefore(imgContainer, prizeCard.firstChild); possiblePrizesDisplay.appendChild(prizeCard);
    });
    rouletteModal.classList.add('active'); if (window.Telegram && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
}
function closeRouletteModal() { rouletteModal.classList.remove('active'); currentOpenCase = null; }
let spinAnimationTimeout;
async function spinRoulette() {
    if (!currentOpenCase) return; clearTimeout(spinAnimationTimeout);
    spinButton.disabled = true; spinButton.textContent = 'Spinning...'; prizeDisplay.classList.add('hidden');
    try {
        const result = await apiRequest('/api/open_case', 'POST', { case_id: currentOpenCase.id });
        if (result.status === 'success') {
            const winner = result.won_prize; currentUser.tonBalance = result.new_balance_ton; updateBalances();
            let spinnerItemsForSpin = []; const availablePrizes = currentOpenCase.prizes.filter(p => p && p.imageFilename);
            for (let i = 0; i < 70; i++) { spinnerItemsForSpin.push(availablePrizes[Math.floor(Math.random() * availablePrizes.length)]);}
            const winnerVisualIndex = Math.floor(spinnerItemsForSpin.length * 0.85); spinnerItemsForSpin[winnerVisualIndex] = winner;
            rouletteSpinner.innerHTML = '';
            spinnerItemsForSpin.forEach(prize => {
                 if (!prize || !prize.imageFilename) return; const itemEl = document.createElement('div'); itemEl.className = 'roulette-item';
                 const img = document.createElement('img'); img.src = IMAGE_BASE_URL + prize.imageFilename; img.alt = prize.name || 'Prize'; img.loading = 'lazy';
                 img.onerror = (e) => { e.target.style.display='none'; itemEl.textContent = '❓'; itemEl.style.fontSize='2em'; }
                 itemEl.appendChild(img); rouletteSpinner.appendChild(itemEl);
             });
            const allItemsInSpinner = rouletteSpinner.querySelectorAll('.roulette-item'); if (allItemsInSpinner.length === 0) { throw new Error("Spinner items not rendered"); }
            const itemHeight = allItemsInSpinner[0].offsetHeight; const rouletteWheelVisibleHeight = rouletteWheel.clientHeight;
            const randomOffset = (Math.random() - 0.5) * (itemHeight * 0.6);
            const landingPosition = (winnerVisualIndex * itemHeight) + (itemHeight / 2) - (rouletteWheelVisibleHeight / 2) + randomOffset;
            rouletteSpinner.style.transition = 'none'; rouletteSpinner.style.top = '0px'; void rouletteSpinner.offsetWidth;
            rouletteSpinner.style.transition = 'top 6s cubic-bezier(0.25, 0.1, 0.2, 1)'; rouletteSpinner.style.top = `-${landingPosition}px`;
            if (window.Telegram && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
            spinAnimationTimeout = setTimeout(() => {
                wonPrizeName.textContent = winner.name; prizeDisplay.classList.remove('hidden');
                spinButton.disabled = false; spinButton.textContent = 'Spin Again';
                const newItemForInventory = { id: result.won_prize.id, name: winner.name, imageFilename: winner.imageFilename, floorPrice: winner.floorPrice, currentValue: result.won_prize.currentValue, upgradeMultiplier: 1.0, obtained_at: Date.now() / 1000 };
                currentUser.inventory.push(newItemForInventory); renderInventory(); showTGNotification(`You got: ${winner.name}!`, 'success');
                 const finalScrollTop = Math.abs(parseFloat(rouletteSpinner.style.top) || 0);
                 const centerLine = finalScrollTop + rouletteWheelVisibleHeight / 2; let closestItemIndex = 0; let minDistance = Infinity;
                 allItemsInSpinner.forEach((item, index) => {
                     const itemCenter = (index * itemHeight) + (itemHeight / 2); const distance = Math.abs(itemCenter - centerLine);
                     if (distance < minDistance) { minDistance = distance; closestItemIndex = index; }
                 });
                 if (allItemsInSpinner[closestItemIndex]) { allItemsInSpinner.forEach(el => el.classList.remove('is-winning')); allItemsInSpinner[closestItemIndex].classList.add('is-winning');}
            }, 6100);
        } else { showTGNotification(result.error || 'Failed to open case.', 'error'); spinButton.disabled = false; spinButton.textContent = 'Spin';}
    } catch (error) { spinButton.disabled = false; spinButton.textContent = 'Spin'; }
}

// --- Other Page Logic ---
async function convertToTon(inventoryItemId) {
    if (!inventoryItemId) return;
    try {
        const result = await apiRequest('/api/convert_to_ton', 'POST', { inventory_item_id: parseInt(inventoryItemId) });
        if (result.status === 'success') {
            currentUser.tonBalance = result.new_balance_ton; currentUser.inventory = currentUser.inventory.filter(item => item.id !== parseInt(inventoryItemId));
            updateBalances(); renderInventory(); showTGNotification(result.message, 'success');
        } else { showTGNotification(result.error || result.message || 'Conversion failed.', 'error');}
    } catch (error) { /* Handled in apiRequest */ }
}
async function handleUpgrade() {
    const selectedItemId = upgradeElements.inventorySelect.value; if (!selectedItemId) { showTGNotification("Please select an item to upgrade.", 'error'); return; }
    upgradeElements.upgradeResult.textContent = "Attempting upgrade..."; upgradeElements.doUpgradeButton.disabled = true;
    try {
        const result = await apiRequest('/api/upgrade_item', 'POST', { inventory_item_id: parseInt(selectedItemId), multiplier_str: selectedMultiplier.toString() });
        if (result.status === 'success') {
            const upgradedItemData = result.item; const itemIndex = currentUser.inventory.findIndex(item => item.id === upgradedItemData.id);
            if (itemIndex !== -1) { currentUser.inventory[itemIndex].currentValue = upgradedItemData.currentValue; currentUser.inventory[itemIndex].upgradeMultiplier = upgradedItemData.upgradeMultiplier; currentUser.inventory[itemIndex].name = upgradedItemData.name; }
            upgradeElements.upgradeResult.textContent = result.message; upgradeElements.upgradeResult.style.color = 'var(--success)'; showTGNotification("Upgrade successful!", 'success');
        } else {
            if (result.message && result.message.includes("lost")) { currentUser.inventory = currentUser.inventory.filter(item => item.id !== parseInt(selectedItemId)); }
            upgradeElements.upgradeResult.textContent = result.message; upgradeElements.upgradeResult.style.color = 'var(--danger)'; showTGNotification("Upgrade failed.", 'error');
        }
        renderInventory(); upgradeElements.doUpgradeButton.disabled = false; upgradeElements.inventorySelect.value = '';
    } catch (error) { upgradeElements.upgradeResult.textContent = "Error during upgrade."; upgradeElements.upgradeResult.style.color = 'var(--danger)'; upgradeElements.doUpgradeButton.disabled = false; }
}
async function sellAllItems() {
    if (currentUser.inventory.length === 0) { showTGNotification("Your inventory is empty.", "info"); return; }
    if (!window.confirm(`Sell all ${currentUser.inventory.length} items? This action cannot be undone.`)) return;
    try {
        const result = await apiRequest('/api/sell_all_items', 'POST');
        if (result.status === 'success') {
            currentUser.tonBalance = result.new_balance_ton; currentUser.inventory = [];
            updateBalances(); renderInventory(); showTGNotification(result.message, "success");
        } else { showTGNotification(result.message || "Failed to sell items.", "error"); }
    } catch (error) { /* Handled in apiRequest */ }
}

// --- Withdraw Flow Logic ---
function showWithdrawStep(stepNumber) { withdrawSteps.forEach((step, index) => { step.classList.toggle('active', index + 1 === stepNumber); });}
function startWithdrawalProcess(itemId) {
    const item = currentUser.inventory.find(i => i.id === parseInt(itemId)); if (!item) { showTGNotification("Item not found for withdrawal.", "error"); return; }
    itemToWithdraw = item.id; withdrawModal.querySelector('h3').textContent = `Withdraw ${item.name}`;
    showWithdrawStep(1); withdrawModal.classList.add('active');
}
async function completeWithdrawal() {
    withdrawStatusMessage.textContent = "Simulating withdrawal process..."; withdrawStatusMessage.style.color = 'var(--text-secondary)';
    const loader = withdrawModal.querySelector('.loader'); if(loader) loader.style.display = 'block';
    await new Promise(resolve => setTimeout(resolve, 2500));
    const itemIndex = currentUser.inventory.findIndex(item => item.id === itemToWithdraw);
    if (itemIndex !== -1) {
         const itemName = currentUser.inventory[itemIndex].name; currentUser.inventory.splice(itemIndex, 1);
         renderInventory(); withdrawStatusMessage.textContent = "Gift withdrawal simulated!"; withdrawStatusMessage.style.color = 'var(--success)';
         showTGNotification(`${itemName} withdrawal simulated!`, 'success');
    } else {
         withdrawStatusMessage.textContent = "Error: Item not found locally."; withdrawStatusMessage.style.color = 'var(--danger)';
         showTGNotification("Error withdrawing item.", 'error');
    }
     if(loader) loader.style.display = 'none';
}
function closeWithdrawModal() { withdrawModal.classList.remove('active'); itemToWithdraw = null; showWithdrawStep(1); withdrawModal.querySelector('h3').textContent = "Withdraw Gift"; }

// --- Deposit Modal Logic ---
async function initiateDepositProcedure() {
    const amountText = profileElements.depositAmountInput.value; if (!amountText.trim()) { showTGNotification("Please enter an amount to deposit.", 'warning'); return; }
    const amount = parseFloat(amountText); const MINIMUM_DEPOSIT_TON_FRONTEND = 0.05;
    if (isNaN(amount) || amount < MINIMUM_DEPOSIT_TON_FRONTEND) { showTGNotification(`Minimum deposit is ${MINIMUM_DEPOSIT_TON_FRONTEND} TON.`, 'error'); return; }
    profileElements.initiateDepositButton.disabled = true; profileElements.initiateDepositButton.textContent = "Initializing...";
    try {
        const result = await apiRequest('/api/initiate_deposit', 'POST', { amount: amount });
        profileElements.initiateDepositButton.disabled = false; profileElements.initiateDepositButton.textContent = "Deposit TON";
        if (result.status === 'success') {
            currentPendingDepositId = result.pending_deposit_id;
            depositModalAmountDisplay.textContent = result.amount_to_send_display;
            tonPaymentLinkButton.href = result.ton_payment_link;
            manualDepositAddress.textContent = result.recipient_address;
            manualDepositAmount.textContent = result.amount_to_send_display;
            manualDepositComment.textContent = result.comment;
            startDepositExpiryTimer(result.expires_at);
            depositStatusMessageEl.textContent = 'Click the button above to pay or check status below.';
            depositLoader.style.display = 'none'; confirmPaymentSentButton.disabled = false;
            confirmPaymentSentButton.textContent = 'I Have Sent The Funds / Check Status';
            depositInstructionsModal.classList.add('active');
        } else {
            if (result.error && result.error.includes("active deposit request")) { showTGNotification(result.message || result.error, 'warning'); }
            else { showTGNotification(result.message || result.error || 'Failed to initiate deposit.', 'error'); }
        }
    } catch (error) { profileElements.initiateDepositButton.disabled = false; profileElements.initiateDepositButton.textContent = "Deposit TON"; }
}
function startDepositExpiryTimer(expiresAtISO) {
    if (depositExpiryInterval) clearInterval(depositExpiryInterval);
    const expiryTime = new Date(expiresAtISO).getTime();
    function updateTimer() {
        const now = new Date().getTime(); const distance = expiryTime - now;
        if (distance < 0) {
            clearInterval(depositExpiryInterval); depositExpiryInfo.textContent = "Deposit request has expired.";
            if(confirmPaymentSentButton) confirmPaymentSentButton.disabled = true;
            if(tonPaymentLinkButton) tonPaymentLinkButton.style.pointerEvents = "none"; return;
        }
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        depositExpiryInfo.textContent = `This request will expire in ${minutes}m ${seconds}s.`;
        if(tonPaymentLinkButton) tonPaymentLinkButton.style.pointerEvents = "auto";
    }
    updateTimer(); depositExpiryInterval = setInterval(updateTimer, 1000);
}
async function verifyPaymentSent() {
    if (!currentPendingDepositId) { showTGNotification("No active deposit to verify/check.", "error"); return; }
    confirmPaymentSentButton.disabled = true; confirmPaymentSentButton.textContent = "Verifying...";
    depositLoader.style.display = 'block'; depositStatusMessageEl.textContent = 'Checking for your transaction... This may take a moment.';
    try {
        const result = await apiRequest('/api/verify_deposit', 'POST', { pending_deposit_id: currentPendingDepositId });
        if (result.status === 'success') {
            showTGNotification(result.message, 'success'); currentUser.tonBalance = result.new_balance_ton;
            updateBalances(); renderProfile(); closeDepositInstructionsModal();
        } else if (result.status === 'pending') {
            depositStatusMessageEl.textContent = result.message; confirmPaymentSentButton.disabled = false; confirmPaymentSentButton.textContent = "Check Status Again";
        } else {
            showTGNotification(result.message || "Verification failed.", (result.status === 'expired' ? 'warning' : 'error'));
            depositStatusMessageEl.textContent = result.message || "Verification failed.";
            if (result.status === 'expired') { if(tonPaymentLinkButton) tonPaymentLinkButton.style.pointerEvents = "none"; }
            else { confirmPaymentSentButton.disabled = false; confirmPaymentSentButton.textContent = "Try Verification Again"; }
        }
    } catch (error) {
        depositStatusMessageEl.textContent = 'An error occurred. Please try again.';
        confirmPaymentSentButton.disabled = false; confirmPaymentSentButton.textContent = "Try Verification Again";
    } finally {
        if (depositLoader.style.display === 'block' && (!depositStatusMessageEl.textContent.includes('Please wait') && !depositStatusMessageEl.textContent.includes('Checking'))) {
             depositLoader.style.display = 'none';
        }
    }
}
function closeDepositInstructionsModal() {
    depositInstructionsModal.classList.remove('active'); if (depositExpiryInterval) clearInterval(depositExpiryInterval);
    profileElements.depositAmountInput.value = '';
}

// --- Event Listeners ---
appNavButtons.forEach(button => { button.addEventListener('click', () => navigateToPage(button.dataset.page)); });
if(spinButton) spinButton.addEventListener('click', spinRoulette);
if(closeRouletteButton) closeRouletteButton.addEventListener('click', closeRouletteModal);
if(profileElements.disconnectWalletButton) profileElements.disconnectWalletButton.addEventListener('click', () => { tonConnectUI.disconnect(); });
if(profileElements.initiateDepositButton) profileElements.initiateDepositButton.addEventListener('click', initiateDepositProcedure);
if(withdrawStep1NextBtn) withdrawStep1NextBtn.addEventListener('click', () => showWithdrawStep(2));
if(withdrawStep2BackBtn) withdrawStep2BackBtn.addEventListener('click', () => showWithdrawStep(1));
if(withdrawStep2NextBtn) withdrawStep2NextBtn.addEventListener('click', () => { showWithdrawStep(3); completeWithdrawal(); });
if(withdrawStep3CloseBtn) withdrawStep3CloseBtn.addEventListener('click', closeWithdrawModal);
if(upgradeElements.multiplierButtons) {
    upgradeElements.multiplierButtons.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', (e) => {
            selectedMultiplier = parseFloat(e.target.dataset.multiplier); const chance = parseFloat(e.target.dataset.chance);
            upgradeElements.chanceDisplay.textContent = `${chance}%`;
            upgradeElements.multiplierButtons.querySelectorAll('button').forEach(btn => { btn.classList.remove('active-multiplier'); if(!btn.classList.contains('button-secondary')) btn.classList.add('button-secondary');});
            e.target.classList.add('active-multiplier'); if(e.target.classList.contains('button-secondary')) e.target.classList.remove('button-secondary');
        });
    });
    const defaultMultiplierButton = upgradeElements.multiplierButtons.querySelector(`[data-multiplier="${selectedMultiplier}"]`);
    if (defaultMultiplierButton) { defaultMultiplierButton.click(); } // Programmatically click to set initial active state
}
if(upgradeElements.doUpgradeButton) upgradeElements.doUpgradeButton.addEventListener('click', handleUpgrade);
if(inviteElements.copyRefLinkButton) inviteElements.copyRefLinkButton.addEventListener('click', () => { navigator.clipboard.writeText(inviteElements.referralLink.value).then(() => showTGNotification("Referral Code copied!", 'success')).catch(err => showTGNotification("Failed to copy code.", 'error'));});
if(inviteElements.withdrawReferralButton) inviteElements.withdrawReferralButton.addEventListener('click', async () => {
    try {
        const result = await apiRequest('/api/withdraw_referral_earnings', 'POST');
        if (result.status === 'success') {
            currentUser.tonBalance = result.new_balance_ton; currentUser.referralEarningsPending = result.new_referral_earnings_pending;
            updateBalances(); renderInvitePage(); showTGNotification(result.message, 'success');
        } else { showTGNotification(result.message || "Failed to withdraw earnings.", 'error');}
    } catch (error) { /* Handled */ }
});
if(profileElements.sellAllButton) profileElements.sellAllButton.addEventListener('click', sellAllItems);
if(confirmPaymentSentButton) confirmPaymentSentButton.addEventListener('click', verifyPaymentSent);
if(cancelDepositButton) cancelDepositButton.addEventListener('click', closeDepositInstructionsModal);

// --- Initialization ---
async function fetchInitialUserData() {
    if (!Telegram.WebApp.initData) {
        console.warn("No initData, cannot fetch user data from backend.");
        if (!window.Telegram || !window.Telegram.WebApp) { updateUIBasedOnWallet(null); renderHeader(); renderCases(); renderProfile(); renderLeaderboard(); renderInvitePage(); navigateToPage('main-page');}
        else { showTGNotification("Error: Telegram data not available. Please restart.", "error"); } return false;
    }
    console.log("Fetching initial user data from backend...");
    try {
        const data = await apiRequest('/api/get_user_data', 'POST', {});
        currentUser.id = data.id; currentUser.username = data.username; currentUser.first_name = data.first_name || 'User'; currentUser.last_name = data.last_name;
        currentUser.tonBalance = data.tonBalance; currentUser.starBalance = data.starBalance || 0; currentUser.inventory = data.inventory || [];
        currentUser.referralCode = data.referralCode; currentUser.referralEarningsPending = data.referralEarningsPending || 0; currentUser.total_won_ton = data.total_won_ton || 0;
        console.log("User data fetched and currentUser updated:", currentUser); return true;
    } catch (error) { console.error("Failed to fetch initial user data:", error); showTGNotification("Could not load your profile data. Please try again later.", 'error'); return false; }
}
async function initializeApp() {
    console.log("initializeApp started for Pusik Gifts");
    preloadImages(imageUrlsToPreload);
    let initialDataFetched = false;
    tonConnectUI.onStatusChange(async wallet => {
        console.log("TON Connect status changed. Wallet:", wallet); updateUIBasedOnWallet(wallet);
        if (!initialDataFetched && window.Telegram && Telegram.WebApp.initData) {
            if (await fetchInitialUserData()) {
                initialDataFetched = true; renderHeader(); renderCases(); renderProfile(); renderLeaderboard(); renderInvitePage(); navigateToPage('main-page');
            }
        }
    });
    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready(); Telegram.WebApp.expand(); console.log("Telegram WebApp is ready and expanded.");
        const tgUser = Telegram.WebApp.initDataUnsafe?.user;
        if (tgUser) {
            console.log("Telegram user data available (unsafe):", tgUser);
            if (!currentUser.id || currentUser.id !== tgUser.id) {
                currentUser.id = tgUser.id; currentUser.username = tgUser.username; currentUser.first_name = tgUser.first_name || 'User'; currentUser.last_name = tgUser.last_name;
                if (!currentUser.referralCode) { currentUser.referralCode = `ref_${currentUser.id.toString().slice(-6)}`; }
            }
        } else { console.warn("Telegram.WebApp.initDataUnsafe.user is not available."); }
        try {
            const rootStyle = getComputedStyle(document.documentElement); const headerColor = rootStyle.getPropertyValue('--bg-primary').trim(); // Use primary bg for header
            if (headerColor) { Telegram.WebApp.setHeaderColor(headerColor); Telegram.WebApp.setBackgroundColor(headerColor); console.log("Telegram theme colors set from CSS.");}
        } catch (e) { console.warn("Could not set Telegram WebApp theme colors from CSS.", e); }
        if (Telegram.WebApp.initData) { console.log("initData is available, calling fetchInitialUserData."); if (await fetchInitialUserData()) { initialDataFetched = true; }
        } else { console.warn("Running in Telegram WebApp, but initData is NOT available at this point."); updateUIBasedOnWallet(null); renderHeader(); renderCases(); renderProfile(); renderLeaderboard(); renderInvitePage(); navigateToPage('main-page');}
    } else {
        console.warn("Telegram WebApp SDK not available. Running in simulated browser mode.");
        if (!currentUser.referralCode) { currentUser.referralCode = `ref_BROWSER${Math.random().toString(36).substring(2, 8)}`;}
        initialDataFetched = true; updateUIBasedOnWallet(null); renderHeader(); renderCases(); renderProfile(); renderLeaderboard(); renderInvitePage(); navigateToPage('main-page');
    }
    if (initialDataFetched) {
        console.log("Initial data fetched, performing final UI render."); renderHeader(); renderCases(); renderProfile(); renderLeaderboard(); renderInvitePage(); navigateToPage('main-page');
    } else { console.warn("Initial data was NOT successfully fetched. UI might be incomplete.");}
    console.log("initializeApp finished for Pusik Gifts.");
}
document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>
